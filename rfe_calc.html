<!DOCTYPE HTML>
<!--
RFE_Calc is free software: you can redistribute it and/or modify it
under the terms of the GNU Lesser General Public License as  published
by the Free Software Foundation, either version 3 of the License, or (at
your option) any later version.

RFE_Calc is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public
License for more details.

You should have received a copy of the GNU Lesser General Public License
along with RFE_Calc.  If not, see <http://www.gnu.org/licenses/>.

Copyright Â© 2009-2010, Vernon Mauery (N7OH)
-->
<html><head>
<meta charset="UTF-8">
<meta name="keywords" content="Amateur Radio RF Safety Calculator, RF Safety, RF Calculator, RF Safety Calculator, frequency, bands, licence, radio frequency, RF, MPE, RFE Calculator">
<meta name="description" content="Calculate RF exposures for various transmitters, antennas and other settings">
<title>N7OH RF Exposure Calculator</title>
<link type="text/css" href="css/jquery-ui.css" rel="stylesheet" />
<style>
div.value {
	display: inline;
}
td.value {
	text-align: center;
}
div.transmitter, div.antenna, div.connection {
	border: 2px solid gray;
	margin: 1em;
	padding: 0em 1em .25em 1em;
}
td.compliant {
	color: green;
}
td.noncompliant {
	color: red;
}
table {
	table-layout: fixed;
}
.error {
	color: red;
}
h4 {
	font-size: 110%;
	margin-top: 0.5em;
	margin-bottom: 0;
}
table th {
	text-align: left;
	font-size: 90%;
}
table td {
	padding: 0em .5em 0em .5em;
}
table.results {
	border: 1px solid;
	font-size: 80%;
	border-collapse: collapse;
}
table.results th {
	border-bottom: 1px solid gray;
	padding: 0.1em 0.5em 0em 0.5em;
	background-color: #d0d0d0;
}
table.results td {
	border-bottom: 1px solid gray;
	padding: 0.1em 0.5em 0em 0.5em;
}
table.results tr.res-row:hover {
	background-color: #e0e0e0;
}
.nowrap {
	white-space: nowrap;
}
.left-border {
	border-left: 1px solid gray;
}
label:after {
	content: ": ";
}
a.add-a, a.edit-a, a.del-a {
	border-bottom: 1px dotted gray;
}
a.primary-link {
	font-size: 120%;
	font-weight: bold;
}
a.link {
	cursor: pointer;
}
.action-box {
	display: none;
}
div.action-box {
	float: right;
}
div.help {
	display: none;
	border: 2px solid gray;
	margin: 1em;
	padding: 0.5em;
}
.help > h2 {
	margin-top: .1em;
	clear: none;
}
a.help-hide {
	color: #0aad0a;
	float: right;
}
a.help {
	color: #cd0a0a;
	float: right;
}
div.text {
	width: 600px;
}
input.number {
	width: 4em;
}
.form-error {
	border: 1px solid #cd0a0a; /* this needs to match the ui-state-error class */
	padding: 0.3em;
	display: none;
	margin-bottom: 0.8em;
}
.initial-noshow {
	display: none;
}
</style>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery-ui.js"></script>
<script type="text/javascript">
<!--//
(function($) {$(function() {

if (!window.console) {
	window.console = {};
	window.console.log = function() {};
	window.console.error = function() {};
}

const cm_per_foot = 30.48;

function array_size(arr) {
	var ret = 0;
	for (var k in arr) {
		ret++;
	}
	return ret;
}
function array_keys(arr) {
	var ret = [];
	for (k in arr) {
		ret.push(k);
	}
	return ret;
}
function array_zip(k, v) {
	var ret = {};
	for (kk in k) {
		ret[k[kk]] = v[kk];
	}
	return ret;
}
// expects an array or associative array and uses
// key/value pairs for options, index for arrays
function select_options(list, selected) {
	var opts = "";
	for (var k in list) {
		if (k == selected) {
			select = ' selected="selected"';
		} else {
			select = '';
		}
		opts += '<option value="'+k+'"'+select+'>'+list[k]+'</option>';
	}
	return opts;
}

function TransmitterBand(xmtr, band, bandinfo) {
	/* initializer */
	this.init = function(xmtr, band, bandinfo) {
		this.id = TransmitterBand.common_id++;
		this.xmtr = xmtr;
		if ( band != null && bandinfo != null) {
			this.band = band;
			this.power = bandinfo[0];
			this.mod = bandinfo[1];
			this.ce = bandinfo[2];
			this.ue = bandinfo[3];
		} else {
			this.band = Bands[0];
			this.power = 100;
			this.mod = modulation_duty_factor[0];
			this.ce = 50;
			this.ue = 100;
		}
		return true;
	};

	this.fini = function() {
		return [this.band, [this.power, this.mod, this.ce, this.ue]];
	};

	/* member functions */
	this.save = function() {
		var band = $('#edit-tband-band').attr('value') || this.band;
		var power = $('#edit-tband-power').attr('value') || this.power;
		var mod = $('#edit-tband-mod').attr('value') || this.mod;
		var ce = $('#edit-tband-ce').attr('value') || this.ce;
		var ue = $('#edit-tband-ue').attr('value') || this.ue;
		console.log('saving '+this.band+' tband, power: '+power+', modulation: '+mod+', cont exp: '+ce+', uncont exp: '+ue);
		// remove the old copy of whatever band this used to be
		// in the case of band renaming, this gets rid of the old band
		// while the assignment below saves us in the new (same?) band
		if (this.band in this.xmtr.bands) {
			delete this.xmtr.bands[this.band];
		}
		this.band = band;
		this.power = power;
		this.mod = mod;
		this.ce = ce;
		this.ue = ue;
		this.xmtr.bands[this.band] = this;
		save_transmitters();
		refresh();
		return true;
	};

	this.ask_delete = function() {
		return confirm('Delete '+this.band+' band?');
	};

	this.editor = function(next) {
		// set the title
		var title;
		if (this.name == "") {
			title = 'Add a band on "'+this.xmtr.name+'"';
		} else {
			title = 'Edit '+this.band+' band  on "'+this.xmtr.name+'"';
		}
		// band is a select, power is input, modulation is select, ce is input, ue is input
		var band_keys = array_keys(bands_filter(this.xmtr.bands, this.band));
		band_keys = array_zip(band_keys, band_keys);
		var mod_keys = array_keys(modulation_duty_factor);
		mod_keys = array_zip(mod_keys, mod_keys);
		$('#edit-tband-band').empty().append(select_options(band_keys, this.band));
		$('#edit-tband-mod').empty().append(select_options(mod_keys, this.mod));
		// set the field values
		$('#edit-tband-band').attr('value', this.band);
		$('#edit-tband-power').attr('value', this.power);
		$('#edit-tband-mod').attr('value', this.mod);
		$('#edit-tband-ce').attr('value', this.ce);
		$('#edit-tband-ue').attr('value', this.ue);
		// set the buttons to reflect this object
		var thing = this;
		$('#tband-editor').dialog('option', {
			'buttons': {
				'Save':function() {
					if (thing.save()) {
						$(this).dialog('close');
						if (next != null) {
							add_a_thing(null, next);
						}
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
				},
			},
			'title': title,
		});
		$('#tband-editor').dialog('open');
	};
	return this.init(xmtr, band, bandinfo);
}
TransmitterBand.common_id = 0;

function Transmitter(init_data) {
	/* intializer */
	this.init = function(init_data) {
		if (init_data == null || init_data.length == 0) {
			this.name = '';
			bands = [];
		} else {
			this.name = init_data[0];
			bands = init_data[1];
		}
		this.id = Transmitter.common_id++;
		this.bands = {};
		for (band in bands) {
			var b = new TransmitterBand(this, band, bands[band]);
			this.bands[band] = b;
		}
		return true;
	};

	this.fini = function() {
		var bands = {};
		for (band in this.bands) {
			var v = this.bands[band].fini();
			bands[v[0]] = v[1];
		}
		return [this.name, bands];
	};

	/* member functions */
	this.ask_delete = function() {
		return confirm('Delete transmitter "'+this.name+'"?');
	};

	this.save = function() {
		var name = $('#edit-xmtr-name').attr('value');
		var samename = transmitter_by_name(name);
		if (samename != null && samename.id != this.id) {
			form_message($('#xmtr-editor-msg'),
				'Transmitter names must be unique',
				$('#edit-xmtr-name')
			);
			return false;
		}
		if (name != this.name) {
			this.name = name;
			console.log('saving '+this.name);
			transmitters[this.id] = this;
			save_connections();
			save_transmitters();
			refresh();
		}
		return true;
	};

	this.editor = function(next) {
		// set the title
		var title;
		if (this.name == "") {
			title = 'Add a transmitter';
		} else {
			title = 'Edit transmitter "'+this.name+'"';
		}
		// set the field values
		$('#edit-xmtr-name').attr('value', this.name);
		// set the buttons to reflect this object
		var thing = this;
		$('#xmtr-editor').dialog('option', {
			'buttons': {
				'Save':function() {
					if (thing.save()) {
						$(this).dialog('close');
						if (next != null) {
							add_a_thing(null, next);
						}
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
				},
			},
			'title': title,
		});
		$('#xmtr-editor').dialog('open');
	};

	this.render = function() {
		var out = '<div class="transmitter action-popup"><div class="action-box">';
		out += '<a class="link add-a" id="add-a-tband-'+this.id+'">Add a band</a> | ';
		out += '<a class="link edit-a" id="edit-a-xmtr-'+this.id+'">Edit</a> |';
		out += '<a class="link del-a" id="del-a-xmtr-'+this.id+'">Delete</a>';
		out += '</div>';
		out += '<h4>'+this.name+'</h4>\n<table width="100%"><tr>';
		out += '<th width="15%">Band</th>';
		out += '<th width="15%">Power (W)</th>';
		out += '<th width="30%">Modulation</th>';
		out += '<th>Controlled<br/>exposure (%)</th>';
		out += '<th>Uncontrolled<br/>exposure (%)</th>';
		out += '<th></th>';
		out += '</tr>\n';
		for (var band in Bands) {
			if (!(band in this.bands)) continue;
			out += '<tr><td>'+band+'</td>';
			out += '<td>'+this.bands[band].power+'</td>';
			out += '<td>'+this.bands[band].mod+' ('+modulation_duty_factor[this.bands[band].mod]+'%)</td>';
			out += '<td>'+this.bands[band].ce+'</td>';
			out += '<td>'+this.bands[band].ue+'</td>';
			out += '<td class="action-box">';
			out += '<a class="link edit-a" id="edit-a-tband-'+this.id+'-'+band+'">Edit</a> |';
			out += '<a class="link del-a" id="del-a-tband-'+this.id+'-'+band+'">Delete</a>';
			out += '</td></tr>\n';
		}
		if (array_size(this.bands) == 0) {
			var msg = 'This transmitter does not yet have bands defined.  Please click on "Add a band".';
			out += '<tr><td colspan="6" class="error">'+msg+'</td></tr>';
		}
		out += '</table></div>';
		return out;
	};

	return this.init(init_data);
}
Transmitter.common_id = 0;

function transmitter_by_name(name) {
	for (var t in transmitters) {
		if (transmitters[t].name == name)
			return transmitters[t];
	}
	return null;
}

function AntennaBand(ant, band, gain) {
	/* initializer */
	this.init = function(ant, band, gain) {
		this.id = AntennaBand.common_id++;
		this.antenna = ant;
		this.band = band;
		this.gain = gain || 2.15;
		return true;
	};

	this.fini = function() {
		return [this.band, this.gain];
	};

	/* member functions */
	this.save = function() {
		var band = $('#edit-aband-band').attr('value');
		var gain = parseFloat($('#edit-aband-gain').attr('value'));
		console.log('saving '+band+' aband, gain: '+gain);
		// remove the old copy of whatever band this used to be
		// in the case of band renaming, this gets rid of the old band
		// while the assignment below saves us in the new (same?) band
		if (this.band in this.antenna.bands) {
			delete this.antenna.bands[this.band];
		}
		this.band = band;
		this.gain = gain;
		this.antenna.bands[this.band] = this;
		save_antennas();
		refresh();
		return true;
	};

	this.ask_delete = function() {
		return confirm('Delete '+this.band+' band?');
	};

	this.editor = function(next) {
		// set the title
		var title;
		if (this.name == "") {
			title = 'Add a band on "'+this.antenna.name+'"';
		} else {
			title = 'Edit '+this.band+' band  on "'+this.antenna.name+'"';
		}
		// band is a select, gain is input
		var band_keys = array_keys(bands_filter(this.antenna.bands, this.band));
		band_keys = array_zip(band_keys, band_keys);
		$('#edit-aband-band').empty().append(select_options(band_keys, this.band));
		// set the field values
		$('#edit-aband-band').attr('value', this.band);
		$('#edit-aband-gain').attr('value', this.gain);
		// set the buttons to reflect this object
		var thing = this;
		$('#aband-editor').dialog('option', {
			'buttons': {
				'Save':function() {
					if (thing.save()) {
						$(this).dialog('close');
						if (next != null) {
							add_a_thing(null, next);
						}
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
				},
			},
			'title': title,
		});
		$('#aband-editor').dialog('open');
	};
	return this.init(ant, band, gain);
}
AntennaBand.common_id = 0;

// ant_data is [bands, cdx, udx, ground]
function Antenna(name, ant_data) {
	this.init = function(name, ant_data) {
		this.id = Antenna.common_id++;
		this.bands = {};
		if (name == null) {
			this.name = '';
			this.cdx = 0;
			this.udx = 0;
			this.ground = true;
		} else {
			this.name = name;
			this.bands = {};
			for (b in ant_data[0]) {
				this.bands[b] = new AntennaBand(this, b, ant_data[0][b]);
			}
			this.cdx = ant_data[1];
			this.udx = ant_data[2];
			this.ground = ant_data[3];
		}
		return true;
	};

	this.fini = function() {
		var bands = {};
		for (band in this.bands) {
			var v = this.bands[band].fini();
			bands[v[0]] = v[1];
		}
		return [this.name, [bands, this.cdx, this.udx, this.ground]];
	};

	this.ask_delete = function() {
		return confirm('Delete antenna "'+this.name+'"?');
	};

	this.save = function() {
		var name = $('#edit-antenna-name').attr('value');
		var cdx = $('#edit-antenna-cdx').attr('value');
		var udx = $('#edit-antenna-udx').attr('value');
		var ground = $('#edit-antenna-ground').attr('value');
		ground = (ground == 'false')?false:true;
		var samename = antenna_by_name(name);
		if (samename != null && samename.id != this.id) {
			form_message($('#antenna-editor-msg'),
				'Antenna names must be unique',
				$('#edit-antenna-name')
			);
			return false;
		}
		console.log('saving "'+this.name+'" antenna, cdx: '+cdx+', udx: '+udx+', ground: '+ground);
		this.name = name;
		this.cdx = cdx;
		this.udx = udx;
		this.ground = ground;
		antennas[this.id] = this;
		save_connections();
		save_antennas();
		refresh();
		return true;
	};

	this.editor = function(next) {
		// set the title
		var title;
		if (this.name == "") {
			title = 'Add an antenna';
		} else {
			title = 'Edit antenna "'+this.name+'"';
		}
		// set the field values
		$('#edit-antenna-name').attr('value', this.name);
		$('#edit-antenna-cdx').attr('value', this.cdx);
		$('#edit-antenna-udx').attr('value', this.udx);
		$('#edit-antenna-ground').attr('value', this.ground);
		// set the buttons to reflect this object
		var thing = this;
		$('#antenna-editor').dialog('option', {
			'buttons': {
				'Save':function() {
					if (thing.save()) {
						$(this).dialog('close');
						if (next != null) {
							add_a_thing(null, next);
						}
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
				},
			},
			'title': title,
		});
		$('#antenna-editor').dialog('open');
	};

	this.render = function() {
		var out = '<div class="antenna action-popup"><div class="action-box">';
		out += '<a class="link add-a" id="add-a-aband-'+this.id+'">Add a band</a> |';
		out += '<a class="link edit-a" id="edit-a-antenna-'+this.id+'">Edit</a> |';
		out += '<a class="link del-a" id="del-a-antenna-'+this.id+'">Delete</a>';
		out += '</div>';
		out += '<h4>'+this.name+'</h4>\n';
		out += 'Controlled exposure: '+this.cdx+'ft, Uncontrolled exposure: '+this.udx+'ft, Ground reflections: '+this.ground+'\n';
		out += '<table width="100%"><tr>';
		out += '<th width="15%">Band</th>';
		out += '<th width="15%">Gain (dBi)</th>';
		out += '<th></th></tr>\n';
		for (var band in Bands) {
			if (!(band in this.bands)) continue;
			out += '<tr><td>'+band+'</td>';
			out += '<td>'+this.bands[band].gain+'</td>';
			out += '<td class="action-box">';
			out += '<a class="link edit-a" id="edit-a-aband-'+this.id+'-'+band+'">Edit</a> |';
			out += '<a class="link del-a" id="del-a-aband-'+this.id+'-'+band+'">Delete</a>';
			out += '</td></tr>\n';
		}
		if (array_size(this.bands) == 0) {
			var msg = 'This antenna does not yet have bands defined.  Please click on "Add a band".';
			out += '<tr><td colspan="3" class="error">'+msg+'</td></tr>';
		}
		out += '</table></div>';
		return out;
	};

	return this.init(name, ant_data);
}
Antenna.common_id = 0;

function antenna_by_name(name) {
	for (var a in antennas) {
		if (antennas[a].name == name)
			return antennas[a];
	}
	return null;
}

// conn_data is [transmitter, antenna, tuner_loss, wire, length, other_loss]
function Connection(conn_data) {
	this.init = function(conn_data) {
		if (conn_data == null) {
			this.transmitter = null;
			this.antenna = null;
			this.tuner_loss = this.length = this.other_loss = 0;
			this.wire = '';
			this.name = '';
		} else {
			this.transmitter = transmitter_by_name(conn_data[0]);
			this.antenna = antenna_by_name(conn_data[1]);
			this.tuner_loss = conn_data[2];
			this.wire = conn_data[3];
			this.length = conn_data[4];
			this.other_loss = conn_data[5];
			this.name = conn_data[0] + ' <-> ' + conn_data[1];
		}
		this.id = Connection.common_id++;
		return true;
	};

	this.fini = function() {
		return [this.transmitter.name, this.antenna.name,
				this.tuner_loss, this.wire, this.length, this.other_loss];
	};

	this.ask_delete = function() {
		return confirm('Delete '+this.name+' connection?');
	};

	this.save = function() {
		var xmtr = transmitters[parseInt($('#edit-conn-xmtr').attr('value'))];
		var ant = antennas[parseInt($('#edit-conn-ant').attr('value'))];
		var tloss = parseFloat($('#edit-conn-tloss').attr('value'));
		var wire = $('#edit-conn-wire').attr('value');
		var wlen = parseFloat($('#edit-conn-wlen').attr('value'));
		var other = parseFloat($('#edit-conn-other').attr('value'));
		var name = xmtr.name + ' <-> ' + ant.name;
		console.log('saving "'+name+'": tloss: '+tloss+', wire: '+wire+', length: '+wlen+', other: '+other);
		tt = this.transmitter;
		tid = this.transmitter?this.transmitter.id:0;
		aid = this.antenna?this.antenna.id:0;

		this.transmitter = xmtr;
		this.antenna = ant;
		this.tuner_loss = tloss;
		this.wire = wire;
		this.length = wlen;
		this.other_loss = other;

		if (tt != null) {
			for (i in connections) {
				if (connections[i].transmitter.id == tid &&
					connections[i].antenna.id == aid) {

					connections[i] = this;
					break;
				}
			}
		} else {
			connections.push(this);
		}
		save_connections();
		refresh();
		return true;
	};

	this.editor = function(next) {
		// set the title
		var title;
		if (this.transmitter == null) {
			title = 'Add an connection';
		} else {
			title = 'Edit connection';
		}
		// set up the selects
		var tid = this.transmitter?this.transmitter.id:null;
		var aid = this.antenna?this.antenna.id:null;
		var wire_keys = array_keys(wires);
		wire_keys = array_zip(wire_keys, wire_keys);
		$('#edit-conn-xmtr').empty().append(select_options(this.xmtr_list(), tid));
		$('#edit-conn-ant').empty().append(select_options(this.ant_list(), aid));
		$('#edit-conn-wire').empty().append(select_options(wire_keys, this.wire));
		// set the field values
		$('#edit-conn-xmtr').attr('value', this.xmtr);
		$('#edit-conn-ant').attr('value', this.ant);
		$('#edit-conn-tloss').attr('value', this.tuner_loss);
		$('#edit-conn-wire').attr('value', this.wire);
		$('#edit-conn-wlen').attr('value', this.length);
		$('#edit-conn-other').attr('value', this.other_loss);
		// set the buttons to reflect this object
		var thing = this;
		$('#conn-editor').dialog('option', {
			'buttons': {
				'Save':function() {
					if (thing.save()) {
						$(this).dialog('close');
						if (next != null) {
							add_a_thing(null, next);
						}
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
				},
			},
			'title': title,
		});
		$('#conn-editor').dialog('open');
	};

	this.render = function() {
		var out = '<div class="connection action-popup"><div class="action-box">';
		out += '<a class="link edit-a" id="edit-a-conn-'+this.id+'">Edit</a> |';
		out += '<a class="link del-a" id="del-a-conn-'+this.id+'">Delete</a>';
		out += '</div>';
		out += '<h4>\''+this.transmitter.name+'\' to \''+this.antenna.name+'\' via '+ this.length+' ft of \''+this.wire+'\'</h4>\n';
		out += '<ul>';
		out += '<li>Transmitter: '+this.transmitter.name+'</li>\n';
		out += '<li>Antenna: '+this.antenna.name+'</li>\n';
		out += '<li>Tuner losses: '+this.tuner_loss+'</li>\n';
		out += '<li>Wire type: '+this.wire+'</li>\n';
		out += '<li>Wire length: '+this.length+'</li>\n';
		out += '<li>Other losses: '+this.other_loss+'</li>\n';
		out += '</ul></div>';
		return out;
	};

	this.results = function() {
		var tm = this.transmitter;
		var ant = this.antenna;
		ret = '<h3>\''+tm.name+'\' to \''+ant.name+'\' via '+ this.length+' ft of \''+this.wire+'\'</h3><div>Controlled distance: '+ant.cdx+' ft., Uncontrolled distance: '+ant.udx+' ft</div>';
		ret += '<table class="results"><tr>';
		ret += '<th rowspan="2">Band</th>';
		ret += '<th rowspan="2" title="Power = power from transmitter for this band">Power (W)</th>';
		ret += '<th rowspan="2" title="Line Losses = loss/ft * line length">Line Losses (dB)</th>';
		ret += '<th rowspan="2" title="Total Gain = antenna gain - (tuner loss + line loss + other loss)">Total Gain (dB)</th>';
		ret += '<th rowspan="2" title="EIRP = total gain * power">EIRP (W)</th>';
		ret += '<th class="left-border" colspan="5">Controlled Exposure (6 minute window)</th>';
		ret += '<th class="left-border" colspan="5">Uncontrolled Exposure (30 minute window)</th>';
		ret += '</tr>\n<tr>';
		ret += '<th class="left-border" title="Time Ave Power = EIRP * modulation duty factor * controlled exposure factor">Time Ave Power (W)</th>';
		ret += '<th title="Maximum Permissible Exposure as specified by the FCC">MPE (mW/cm<sup>2</sup>)</th>';
		ret += '<th title="RF Exposure as calculated for this scenario">RF Exposure (mW/cm<sup>2</sup>)</th>';
		ret += '<th title="Minimum distance to antenna to be within compliance">Minimum Distance (ft)</th>';
		ret += '<th>Distance OK</th>';
		ret += '<th class="left-border" title="Time Ave Power = EIRP * modulation duty factor * uncontrolled exposure factor">Time Ave Power (W)</th>';
		ret += '<th title="Maximum Permissible Exposure as specified by the FCC">MPE (mW/cm<sup>2</sup>)</th>';
		ret += '<th title="RF Exposure as calculated for this scenario">RF Exposure (mW/cm<sup>2</sup>)</th>';
		ret += '<th title="Minimum distance to antenna to be within compliance">Minimum Distance (ft)</th>';
		ret += '<th>Distance OK</th>';
		ret += '</tr>\n';
		var bands_rendered = 0;
		for (var b in Bands) {
			if (!(b in tm.bands) || ant.bands[b] == null) continue;
			bands_rendered++;
			var band = tm.bands[b];
			var freq = Bands[b][1];
			var line_loss = (this.length/100.0)*wires[this.wire][b];
			if (wires[this.wire][b] == null) {
				console.error("Wire '"+this.wire+"' has no loss info at "+b);
				line_loss = 0;
			}
			var tloss = this.tuner_loss + this.other_loss + line_loss;
			var tlossdb = -tloss + ant.bands[b].gain;
			tloss = Math.pow(10, -(tloss/10.0));
			var gain = Math.pow(10, ant.bands[b].gain/10.0);
			ret += '<tr class="res-row">';
			// calculate rfe/mpe/mdx for transmitter power at band with connection losses
			ce = calc_exposure(true, band.power, modulation_duty_factor[band.mod]/100.0, band.ce/100.0, tloss, gain, freq, ant.cdx*cm_per_foot, ant.ground);
			ue = calc_exposure(false, band.power, modulation_duty_factor[band.mod]/100.0, band.ue/100.0, tloss, gain, freq, ant.udx*cm_per_foot, ant.ground);
			ret += '<td class="nowrap">'+b+'</td><td>'+band.power+'</td>';
			ret += '<td>'+line_loss.toPrecision(4)+'</td>';
			ret += '<td>'+tlossdb.toPrecision(4)+'</td>';
			ret += '<td>'+(band.power*tloss*gain).toPrecision(4)+'</td>';
			// controlled exposure
			ret += '<td class="left-border">'+ce.avgp.toPrecision(4)+'</td>';
			ret += '<td>'+ce.mpe.toPrecision(4)+'</td>';
			ret += '<td>'+ce.rfe.toPrecision(4)+'</td>';
			ret += '<td>'+(ce.mdx/cm_per_foot).toPrecision(4)+'</td>';
			ret += '<td class="'+(ce.rfe < ce.mpe ? '':'non')+'compliant">'+(ce.rfe < ce.mpe ? 'Yes':'No')+'</td>';
			// uncontrolled exposure
			ret += '<td class="left-border">'+ue.avgp.toPrecision(4)+'</td>';
			ret += '<td>'+ue.mpe.toPrecision(4)+'</td>';
			ret += '<td>'+ue.rfe.toPrecision(4)+'</td>';
			ret += '<td>'+(ue.mdx/cm_per_foot).toPrecision(4)+'</td>';
			ret += '<td class="'+(ue.rfe < ue.mpe ? '':'non')+'compliant">'+(ue.rfe < ue.mpe ? 'Yes':'No')+'</td>';
			ret += '</tr>';
		}
		if (bands_rendered == 0) {
			if (array_size(tm.bands) == 0) {
				msg = 'Transmitter "'+tm.name+'" has no bands. Please go to the Transmitters tab and add bands there first.';
			} else if (array_size(ant.bands) == 0) {
				msg = 'Antenna "'+ant.name+'" has no bands. Please go to the Antennas tab and add bands there first.';
			} else {
				msg = 'There are no bands on transmitter "'+tm.name+'" that match the bands on antenna "'+ant.name+'".  Make sure that the bands are correct for your transmitter and antenna.';
			}
			ret += '<tr><td colspan="15" class="error">'+msg+'</td></tr>';
		}
		ret += '</table>';
		return ret;
	};

	this.xmtr_list = function() {
		var ret = {};
		for (var t in transmitters) {
			ret[transmitters[t].id] = transmitters[t].name;
		}
		return ret;
	};

	this.ant_list = function() {
		var ret = {};
		for (var a in antennas) {
			ret[antennas[a].id] = antennas[a].name;
		}
		return ret;
	};

	return this.init(conn_data);
}
Connection.common_id = 0;

function form_message(f, m, w) {
	if (!m) {
		f.text('');
		f.hide();
		return;
	}
	w.addClass('ui-state-error');
	f.text(m).addClass('ui-state-error');
	f.show();
	setTimeout(function() {
			f.removeClass('ui-state-error');
		}, 3000);
}

function connection_idx_from_transmitter(name) {
	conns = [];
	for (var c in connections) {
		var t = connections[c].transmitter;
		//console.log('compare "'+name+'" to "'+t.name+'"');
		if (t.name == name) {
			console.log('found connection: '+connections[c].name);
			conns.push(c);
		}
	}
	return conns;
}

function connection_idx_from_antenna(name) {
	conns = [];
	for (var c in connections) {
		var a = connections[c].antenna;
		//console.log('compare "'+name+'" to "'+a.name+'"');
		if (a.name == name) {
			console.log('found connection: '+connections[c].name);
			conns.push(c);
		}
	}
	return conns;
}

function add_a_thing(ele, next) {
	var type;
	var id;
	var thing;
	if (next == null) {
		var m = $(ele).attr('id').split('-');
		type = m[2];
		id = parseInt(m[3]);
		thing = null;
	} else {
		console.log('add a thing next: '+next);
		type = next[0];
		id = next[1];
	}
	switch (type) {
		case "xmtr":
			thing = new Transmitter();
			next = [ 'tband', thing.id ];
			break;
		case "tband":
			thing = new TransmitterBand(transmitters[id]);
			break;
		case "antenna":
			thing = new Antenna();
			next = [ 'aband', thing.id ];
			break;
		case "aband":
			thing = new AntennaBand(antennas[id]);
			break;
		case "connection":
			thing = new Connection();
			break;
	}
	if (thing == null) return;
	thing.editor(next);
}

function edit_a_thing(ele) {
	var m = $(ele).attr('id').split('-');
	var type = m[2];
	var id = parseInt(m[3]);
	var index = m[4];
	var thing = null;
	console.log('edit_a_thing: type = '+type+', id = '+id+', index = '+index);
	switch (type) {
		case "xmtr":
			thing = transmitters[id];
			break;
		case "tband":
			thing = transmitters[id].bands[index];
			break;
		case "antenna":
			thing = antennas[id];
			break;
		case "aband":
			thing = antennas[id].bands[index];
			break;
		case "conn":
			thing = connections[id];
			break;
	}
	if (thing == null) return;
	thing.editor();
}

function del_a_thing(ele) {
	var m = $(ele).attr('id').split('-');
	var type = m[2];
	var id = parseInt(m[3]);
	var index = m[4];
	var thing = null;
	console.log('del_a_thing: type = '+type+', id = '+id+', index = '+index);
	switch (type) {
		case "xmtr":
			if (transmitters[id].ask_delete()) {
				var name = transmitters[id].name;
				var conns = connection_idx_from_transmitter(name);
				for (var c in conns) {
					console.log('deleting conn '+connections[conns[c]].name);
					delete connections[conns[c]];
				}
				delete transmitters[id];
				save_transmitters();
				save_connections();
			} else return;
			break;
		case "tband":
			if (transmitters[id].bands[index].ask_delete()) {
				delete transmitters[id].bands[index];
				save_transmitters();
			} else return;
			break;
		case "antenna":
			if (antennas[id].ask_delete()) {
				var name = antennas[id].name;
				var conns = connection_idx_from_antenna(name);
				for (var c in conns) {
					console.log('deleting conn '+connections[conns[c]].name);
					delete connections[conns[c]];
				}
				delete antennas[id];
				save_antennas();
				save_connections();
			} else return;
			break;
		case "aband":
			if (antennas[id].bands[index].ask_delete()) {
				delete antennas[id].bands[index];
				save_antennas();
			} else return;
			break;
		case "conn":
			if (connections[id].ask_delete()) {
				for (var c in connections) {
					if (connections[c].id == id) {
						console.log('deleting conn '+connections[c].name);
						delete connections[c];
					}
				}
			} else return;
			break;
	}
	refresh();
}

function post_render() {
	$(".link").filter(".add-a").unbind('click').click(function() {
			add_a_thing(this);
	});
	$(".link").filter(".del-a").unbind('click').click(function() {
			del_a_thing(this);
	});
	$(".link").filter(".edit-a").unbind('click').click(function() {
			edit_a_thing(this);
	});
	$(".link").filter("#reset-data").unbind('click').click(function() {
		console.log('resetting data');
		reset_data_store();
	});
	var prot = ["&#109;", "&#97;", "&#105;", "&#108;", "&#116;", "&#111;", "&#58;"].join('');
	var addr = ["&#110;", "&#55;", "&#111;", "&#104;", "&#64;", "&#97;", "&#114;", "&#114;", "&#108;", "&#46;", "&#110;", "&#101;", "&#116;"];
	addr = addr.join('');
	$("#contact").replaceWith('<a href="'+prot+addr+'">'+addr+'</a>');
}

var wires = {
	'RG-8X': {'160m':0.349, '80m':0.656, '60m':0.809, '40m':0.931, '30m':1.116, '20m':1.352, '17m':1.507, '15m':1.631, '12m':1.855, '10m':1.890, '6m':2.55, '2m':4.458,},
	'RG-213/U': {'160m':0.192, '80m':0.361, '60m':0.446, '40m':0.514, '30m':0.616, '20m':0.732, '17m':0.833, '15m':0.901, '12m':1.026, '10m':1.045, '6m':1.413, '2m':2.482, },
	'LL-400': {'160m':0.2, '80m':0.22, '60m':0.28, '40m':0.3, '30m':0.35, '20m':0.40, '17m':0.45, '15m':0.54, '12m':0.6, '10m':0.67, '6m':0.88, '2m':1.52, '220 MHz':1.86, '440 MHz':2.71, '900 MHz':3.9, },
	'LL-600': {'160m':0.1, '80m':0.12, '60m':0.14, '40m':0.16, '30m':0.2, '20m':0.22, '17m':0.25, '15m':0.29, '12m':0.35, '10m':0.43, '6m':0.55, '2m':0.98, '220 MHz':1.19, '440 MHz':1.71, '900 MHz':2.5, },
	'WM CQ 551': {'160m':0.02, '80m':0.04, '60m':0.06, '40m':0.08, '30m':0.08, '20m':0.10, '17m':0.12, '15m':0.12, '12m':0.13, '10m':0.14, '6m':0.15, '2m':0.35, },
};
var Bands = {
	'160m':[1800000,2000000],
	'80m':[3500000,4000000],
	'60m':[5330000,5405000],
	'40m':[7000000,7300000],
	'30m':[10100000,10150000],
	'20m':[14000000,14350000],
	'17m':[18068000,18168000],
	'15m':[21000000,21450000],
	'12m':[24890000,24990000],
	'10m':[28000000,29700000],
	'6m':[50000000,54000000],
	'2m':[144000000,148000000],
	'220 MHz':[222000000,225000000],
	'440 MHz':[420000000,450000000],
	'900 MHz':[902000000,928000000],
	'1.2 GHz':[1240000000,1300000000],
	'2.3 GHz':[2300000000,2310000000],
	'2.4 GHz':[2390000000,2450000000],
	'3.3 GHz':[3300000000,3500000000],
	'5.6 GHz':[5650000000,5925000000],
	'10 GHz':[10000000000,10500000000],
	'24 GHz':[24000000000,24250000000],
	'47 GHz':[47000000000,47200000000],
	'76 GHz':[76000000000,81000000000],
	'122 GHz':[122250000000,123000000000],
	'134 GHz':[134000000000,141000000000],
	'241 GHz':[241000000000,250000000000],
	'275 GHz':[275000000000,300000000000],
};
function bands_filter(bands, current_band) {
	var ret = {};
	for (band in Bands) {
		if (band == current_band || !(band in bands)) {
			ret[band] = Bands[band];
		}
	}
	return ret;
}


var modulation_duty_factor = {
	'CW': 40,
	'SSB: no processing': 20,
	'SSB: medium processing': 40,
	'SSB: heavy processing': 50,
	'SSB AFSK': 100,
	'SSB SSTV': 100,
	'FSK': 100,
	'FM': 100,
	'AM: 50% modulation': 50,
	'AM: 100% modulation': 25,
	'AM: carrier': 100,
	'ATV': 60,
};

var transmitters = {};
var antennas = {};
var connections = [];

function serialize_transmitters() {
	var xmtr_data = {}
	for (var k in transmitters) {
		var v = transmitters[k].fini();
		xmtr_data[v[0]] = v[1];
	}
	return xmtr_data;
}
function save_transmitters() {
	setvar('transmitters', serialize_transmitters());
}
function load_transmitters(xmtr_data) {
	xmtr_data = xmtr_data || getvar('transmitters', {});
	var t = {}
	for (var k in xmtr_data) {
		var nt = new Transmitter([k, xmtr_data[k]]);
		t[nt.id] = nt;
	}
	return t;
}
function serialize_antennas() {
	var ant_data = {}
	for (var k in antennas) {
		var v = antennas[k].fini();
		ant_data[v[0]] = v[1];
	}
	return ant_data;
}
function save_antennas() {
	setvar('antennas', serialize_antennas());
}
function load_antennas(ant_data) {
	ant_data = ant_data || getvar('antennas', {});
	var a = {};
	for (var k in ant_data) {
		var na = new Antenna(k, ant_data[k]);
		a[na.id] = na;
	}
	return a;
}
function serialize_connections() {
	var conn_data = new Array();
	for (var k in connections) {
		conn_data.push(connections[k].fini());
	}
	return conn_data;
}
function save_connections() {
	setvar('connections', serialize_connections());
}
function load_connections(conn_data) {
	conn_data = conn_data || getvar('connections', []);
	var c = [];
	for (var k in conn_data) {
		c[k] = new Connection(conn_data[k]);
	}
	return c;
}

function reset_data_store() {
	if ((array_size(transmitters) ||
		array_size(antennas) ||
		array_size(connections)) &&
		!confirm('This cannot be undone.\nReplace all transmitter/antenna/connection data?')) {
			return;
	}
	var ltransmitters = {
		// Transmitter(name, bands)
		//band info is [power, duty cycle, win_c, win_u]
		'IC-7000':{'160m':[100, 'CW', 50, 50], '80m':[100, 'CW', 50, 50], '60m':[50, 'SSB: medium processing', 50, 50], '40m':[100, 'SSB: medium processing', 50, 50], '30m':[100, 'SSB: medium processing', 50, 50], '20m':[100, 'SSB: medium processing', 50, 50], '17m':[100, 'SSB: medium processing', 50, 50], '15m':[100, 'SSB: medium processing', 50, 50], '12m':[100, 'SSB: medium processing', 50, 50], '10m':[100, 'SSB: medium processing', 50, 30], '6m':[100, 'FM', 50, 50], '2m':[50, 'FM', 50, 50], '440 MHz':[30, 'FM', 50, 50]},
		'Elecraft K3/100':{'160m':[100, 'CW', 50, 50], '80m':[100, 'CW', 50, 50], '60m':[50, 'SSB: medium processing', 50, 50], '40m':[100, 'SSB: medium processing', 50, 50], '30m':[100, 'SSB: medium processing', 50, 50], '20m':[100, 'SSB: medium processing', 50, 50], '17m':[100, 'SSB: medium processing', 50, 50], '15m':[100, 'SSB: medium processing', 50, 50], '12m':[100, 'SSB: medium processing', 50, 50], '10m':[100, 'SSB: medium processing', 50, 30]},
		'IC-92AD':{'2m':[5, 'FM', 50, 50], '440 MHz':[5, 'FM', 50, 50]},
	};
	var lantennas = {
		// Antenna(name, bands, cdx, udx, ground)
		'Center-fed Zepp':[{'80m':1.9, '60m':2.0, '40m':2.5, '30m':3.1, '20m':3.1, '17m':3.1, '15m':3.1, '12m':3.2, '10m':3.2,}, 18, 16, true],
		'6/2/440 collinear':[{'6m':3.07, '2m':8.3, '440 MHz':11.7}, 6, 15, true],
		'2/440 collinear':[{'2m':3.76, '440 MHz':4.32}, 1, 50, true],
		'2/440 dipole':[{'2m':2.2, '440 MHz':3.02}, 1, 50, true],
	};
	var lconnections = [
		// Connection(transmitter, antenna, tuner_loss, wire, length, other_loss)
		['Elecraft K3/100', 'Center-fed Zepp', 0.1, 'LL-400', 150, 0.2],
		['IC-7000', 'Center-fed Zepp', 0.1, 'RG-8X', 150, 0.2],
		['IC-7000', '6/2/440 collinear', 0.0, 'LL-400', 150, 0.2],
		['IC-92AD', '6/2/440 collinear', 0.0, 'LL-400', 150, 0.2],
		['IC-92AD', '2/440 collinear', 0.0, 'LL-400', 30.0, 0.0],
		['IC-92AD', '2/440 dipole', 0.0, 'LL-400', 30.0, 0.0],
		];
	setvar('antennas', lantennas);
	setvar('transmitters', ltransmitters);
	setvar('connections', lconnections);
	setvar('schema', SCHEMA);
	/*
	// this only makes sense if we are not reloading the window
	transmitters = load_transmitters();
	antennas = load_antennas();
	connections = load_connections();
	refresh();
	*/
	window.location.reload(true);
}

function page_init() {
	$('#eximport-import').unbind('click').click(import_data);
	$('#eximport-export').unbind('click').click(export_data);
	$('#eximport-reset').unbind('click').click(reset_data);
	$('#eximport-sample').unbind('click').click(reset_data_store);
	$('.hideme').hide();
	// set up the modal dialogs
	$('#tband-editor').dialog({
		autoOpen: false,
		width: '24em',
		modal: true,
		close: function() {
			$('#edit-tband-power').removeClass('ui-state-error');
			$('#edit-tband-ce').removeClass('ui-state-error');
			$('#edit-tband-ue').removeClass('ui-state-error');
			form_message($('#tband-editor-msg'));
		}
	});
	$('#xmtr-editor').dialog({
		autoOpen: false,
		width: '24em',
		modal: true,
		close: function() {
			$('#edit-xmtr-name').removeClass('ui-state-error');
			form_message($('#xmtr-editor-msg'));
		}
	});
	$('#aband-editor').dialog({
		autoOpen: false,
		width: '24em',
		modal: true,
		close: function() {
			$('#edit-aband-gain').removeClass('ui-state-error');
			form_message($('#aband-editor-msg'));
		}
	});
	$('#antenna-editor').dialog({
		autoOpen: false,
		width: '24em',
		modal: true,
		close: function() {
			$('#edit-antenna-name').removeClass('ui-state-error');
			$('#edit-antenna-cdx').removeClass('ui-state-error');
			$('#edit-antenna-udx').removeClass('ui-state-error');
			form_message($('#antenna-editor-msg'));
		}
	});
	$('#conn-editor').dialog({
		autoOpen: false,
		width: '24em',
		modal: true,
		close: function() {
			$('#edit-conn-tloss').removeClass('ui-state-error');
			$('#edit-conn-wlen').removeClass('ui-state-error');
			$('#edit-conn-other').removeClass('ui-state-error');
			form_message($('#conn-editor-msg'));
		}
	});
}

function log_err(msg, e) {
	console.error(msg + ': '+e.stack);
}

function refresh(mask_errors) {
	if (mask_errors == null) mask_errors = true;
	var error = null;
	try {
		show_transmitters();
	} catch (e) { log_err('transmitters failed to render: ', e); error = e; }; try {
		show_antennas();
	} catch (e) { log_err('antennas failed to render: ', e); error = e; }; try {
		show_connections();
	} catch (e) { log_err('connections failed to render: ', e); error = e; }; try {
		show_results();
	} catch (e) { log_err('results failed to render: ', e); error = e; }
	if (error != null && !mask_errors) throw error;
	do_interactive();
	post_render();
}
function show_transmitters() {
	console.log('show_transmitters');
	$('#transmitters > .dynamic').children().remove();
	var rendered_something = false;
	for (var t in transmitters) {
		rendered_something = true;
		$('#transmitters > .dynamic').append(transmitters[t].render());
	}
	if (!rendered_something) {
		$('#help-xmtr').hide();
		$('#help-text-xmtr').show();
	}
}
function show_antennas() {
	console.log('show_antennas');
	$('#antennas > .dynamic').children().remove();
	var rendered_something = false;
	for (var a in antennas) {
		rendered_something = true;
		$('#antennas > .dynamic').append(antennas[a].render());
	}
	if (!rendered_something) {
		$('#help-antenna').hide();
		$('#help-text-antenna').show();
	}
}
function show_connections() {
	console.log('show_connections');
	$('#connections > .dynamic').children().remove();
	var rendered_something = false;
	for (var c in connections) {
		rendered_something = true;
		$('#connections > .dynamic').append(connections[c].render());
	}
	if (!rendered_something) {
		$('#help-connection').hide();
		$('#help-text-connection').show();
	}
}
function show_results() {
	console.log('show_results');
	$('#results > .dynamic').children().remove();
	var rendered_something = false;
	for (var c in connections) {
		rendered_something = true;
		$('#results > .dynamic').append(connections[c].results());
	}
	if (!rendered_something) {
		$('#help-results').hide();
		$('#help-text-results').show();
	}
// | transmitter | power | band | tuner losses | line losses | other losses | rfe | mpe | mdx | ok
}
function reset_data() {
	if ((array_size(transmitters) ||
		array_size(antennas) ||
		array_size(connections)) &&
		!confirm('This cannot be undone.\nDelete all transmitter/antenna/connection data?')) {
			return;
	}
	delvar('antennas');
	delvar('connections');
	delvar('transmitters');
	delete transmitters;
	delete antennas;
	delete connections;
	setvar('schema', SCHEMA);
	window.location.reload(true);
}
function export_data() {
	var data = {
		'schema': getvar('schema', SCHEMA),
		'antennas': getvar('antennas', {}),
		'connections': getvar('connections', []),
		'transmitters': getvar('transmitters', {}),
	};
	$('#eximport-data').val(JSON.stringify(data));
}
function import_data() {
	if ((array_size(transmitters) ||
		array_size(antennas) ||
		array_size(connections)) &&
		!confirm('This cannot be undone.\nReplace all transmitter/antenna/connection data?')) {
			return;
	}
	var oldant = antennas,
		oldcon = connections,
		oldxmtr = transmitters,
		oldschema = getvar('schema', 0);
	try {
		var data = $('#eximport-data').val();
		if (data.length < 60) return;
		console.log('import:\n'+data);
		data = JSON.parse(data);
		setvar('antennas', data['antennas']);
		setvar('connections', data['connections']);
		setvar('transmitters', data['transmitters']);
		setvar('schema', data['schema'] || 0)
		check_schema();
		transmitters = load_transmitters();
		antennas = load_antennas();
		connections = load_connections();
		refresh(false);
	} catch (e) {
		log_err('failed to import: ', e);
		alert('Imported data was not in correct format');
		antennas = oldant;
		connections = oldcon;
		transmitters = oldxmtr;
		save_antennas();
		save_connections();
		save_transmitters();
		setvar('schema', oldschema);
	}
	window.location.reload(true);
}
function calc_mpe(frequency, controlled) {
	frequency /= 1000000;
	if (frequency < 1.34) {
		return 100.0;
	}  /**  Below 1.34 MHz  **/
	else if (frequency < 3.0) {
		if (controlled) return 100.0;
		return 180.0 / (Math.pow(frequency,2));
	}  /**  Below 3.0 MHz  **/
	else if (frequency < 30.0) {
		if (controlled) return 900.0 / Math.pow(frequency,2);
		return 180.0 / (Math.pow(frequency,2));
	}  /**  Below 30 MHz  **/
	else if (frequency < 300.0) {
		if (controlled) return 1.0;
		return 0.2;
	}  /**  Below 300 MHz  **/
	else if (frequency < 1500.0) {
		if (controlled) return frequency / 300.0
			return frequency / 1500.0;
	}  /**  Below 1500 MHz  **/
	else if (frequency < 100000.0) {
		if (controlled) return 5.0;
		return 1.0;
	}  /**  Below 100 GHz  **/
	else {  /**  Frequency too high  **/
		console.error("The FCC does not have exposure limits above 100 GHz.  Please try again.");
		return;
	}  /**  Frequency too high  **/
}
/* inputs:
  @controlled: this is controlled or uncontrolled (bool)
  @watts: max watts at transmitter
  @tdc: transmission duty cycle (~20% for voice, ~40% for CW)
  @winave: average window x/6 for controlled, x/30 for controlled
  @tloss: total losses from transmitter to antenna (fraction, not in dB)
  @gain: antenna gain (fraction, not in dB)
  @dx: distance from center of antenna in cm
  @ground: calculate ground reflections (bool)
  returns:
  @pd: power density
  @mpe: maximum permissible exposure
  @dxm: minimum distance to compliance in cm
*/
function calc_exposure(controlled, watts, tdc, winave, tloss, gain, freq, dx, ground) {
	//console.log('calc_exposure('+controlled+', '+watts+', '+tdc+', '+winave+', '+tloss+', '+gain+', '+freq+', '+dx+', '+ground);
	var power_w = tdc * tloss * watts * winave * gain;
	var power_mw = power_w * 1000;
	var rfe, mpe, mdx;
	if ((power_mw > 0) && (dx > 0)) {
		if (ground) {
			// EPA model says 1.6 times field strength or 1.6*1.6 power density factor
			gf = 2.56;
		} else {
			gf = 1;
		}
		rfe = (gf * power_mw) / (4 *Math.PI * Math.pow(dx,2));
		mpe = calc_mpe(freq, controlled);
		mdx = Math.sqrt((gf * power_mw)/(mpe * Math.PI));
	}
	//console.log("{rfe:"+rfe+", mpe:"+mpe+", mdx:"+mdx+"}");
	return {avgp:power_w, rfe:rfe, mpe:mpe, mdx:mdx};
}
function hide_elements(ele) {
	$(ele).children().filter('.action-box').hide();
}
function do_interactive() {
	$('.action-popup').hover(function() {
		$(this).find('.action-box').show();
	}, function() {
		$(this).find('.action-box').hide();
	});
	$('.link').filter('.help').unbind('click').click(function() {
		var m = $(this).attr('id').split('-');
		var type = m[1];
		$('#help-'+type).hide();
		$('#help-text-'+type).slideDown(250);
	});
	$('.link').filter('.help-hide').unbind('click').click(function() {
		var m = $(this).attr('id').split('-');
		var type = m[2];
		$('#help-text-'+type).slideUp(250, function() {
			$('#help-'+type).show();
		});
	});
}
function delvar(name) {
	window.localStorage.removeItem('rfe.'+name);
}
function setvar(name, value) {
	window.localStorage['rfe.'+name] = JSON.stringify(value);
}
function getvar(name, default_value) {
	var v = window.localStorage['rfe.'+name];
	if (v == null)
		return default_value;
	return JSON.parse(v);
}
const SCHEMA = 1;
function update_schema(ver) {
	switch (ver) {
		case 1:
			// renamed some of the modulation factors
			var remap = {
				'SSB voice low': 'SSB: no processing',
				'SSB voice high': 'SSB: medium processing',
				'AM 50%': 'AM: 50% modulation',
				'AM 100%': 'AM: 100% modulation',
				'AM 0%': 'AM: carrier',
			};
			transmitters = load_transmitters();
			var updated_transmitters = false;
			for (var t in transmitters) {
				for (var tb in transmitters[t].bands) {
					for (k in remap) {
						if (k == transmitters[t].bands[tb].mod) {
							//console.log('updating '+transmitters[t].name+':'+transmitters[t].bands[tb].band+' modulation from "'+transmitters[t].bands[tb].mod+'" to "'+remap[k]+'"');
							transmitters[t].bands[tb].mod = remap[k];
							updated_transmitters = true;
						}
					}
				}
			}
			if (updated_transmitters) {
				save_transmitters();
			}
			delete transmitters;
			return true;
		default:
			return true;
	}
}
function check_schema() {
	var schema = getvar('schema', 0);
	var success = true;
	if (schema < SCHEMA) {
		//console.log('updating schema');
		for (var i=schema+1; i<=SCHEMA; i++) {
			console.log('updating to schema version '+i);
			success &= update_schema(i);
		}
		if (!success) {
			alert('Sorry, some database updates failed to apply.\nYour data may be broken now.  The best thing would be to edit\nanything that looks broken to see if you can fix it.');
		}
		setvar('schema', SCHEMA);
	} else if (schema > SCHEMA) {
		alert('The database schemas do not match, you must be viewing an old\nversion of the calculator with new data,\nor tried to import data from a newer version.\nClear your browser cache and try again.');
	}
}

if (('localStorage' in window) && window['localStorage'] !== null) {
	check_schema();
	$("#tabs").tabs();
	transmitters = load_transmitters();
	antennas = load_antennas();
	connections = load_connections();
	page_init();
	refresh();
}

}); })(jQuery);

-->
</script>
</head><body bgcolor="#ffffff" text="#000000">

<div id="tabs">
	<ul>
		<li><a href="#transmitters"><span>Transmitters</span></a></li>
		<li><a href="#antennas"><span>Antennas</span></a></li>
		<li><a href="#connections"><span>Connections</span></a></li>
		<li><a href="#results"><span>Results</span></a></li>
		<li><a href="#eximport"><span>Import/Export</span></a></li>
		<li><a href="#about"><span>About</span></a></li>
	</ul>
	<div id="transmitters" class="initial-noshow">
		<a class="link add-a primary-link" id="add-a-xmtr">Add a transmitter</a>
		<a class="link help" id="help-xmtr">Help!</a>
		<div class="help" id="help-text-xmtr">
			<a class="link help-hide" id="help-hide-xmtr">Hide help</a>
			<h2>Transmitters</h2>
			<p>
			The Transmitters tab is where you should start.  In this tab, you
			add a transmitter for each one you want to run calculations for.
			You get to pick the name, but the names must be unique, so if you
			have three of one radio, give them a suffix or something.
			</p><p>
			After clicking on "Add a transmitter", you will be prompted to "Add
			a band" for that transmitter.  Just like your real radio, each
			transmitter here can have its own bands.  It will continue to
			prompt you to add new bands until you hit "Cancel".  If you decide
			at some later time to add more bands, you can manually click on the
			"Add a band" link inside the transmitter box.  Deleting or editing
			the bands and/or transmitters can be done with those links as well.
			</p><p>
			As you add the bands, you specify information on how you will be
			using that band for this calculator.  For example, if you typically
			use 50W on the 80m band while using CW, you should enter that data
			there.  This way, you can model your real-life usage of the radio.
			In addition, you should enter your usage windows for controlled and
			uncontrolled exposure.  Remember that the controlled exposure
			window is six minutes long and the uncontrolled window is 30
			minutes.  These two fields here are not in minutes, but rather in
			percentage.  So fill in the percentages appropriately.
			</p><p>
			If you are using an amplifier with your radio, you can just assume
			that the radio is putting out the amplifier's output for the sake
			of simplification.
			</p><p>
			You only get to fill out each band once per transmitter, so use the
			highest power configuration you plan on using.  Note that the
			various modulation modes and exposure percentages will also reduce
			the total RFE in the calculations.
			</p><p>
			After adding all your transmitters and transmitter bands, go on to
			the Antennas tab.
			</p>
		</div>
		<div class="dynamic">
		</div>
	</div>
	<div id="antennas" class="initial-noshow">
		<a class="link add-a primary-link" id="add-a-antenna">Add an antenna</a>
		<a class="link help" id="help-antenna">Help!</a>
		<div class="help" id="help-text-antenna">
			<a class="link help-hide" id="help-hide-antenna">Hide help</a>
			<h2>Antennas</h2>
			<p>
			The Antennas tab is where you enter information about your
			antennas.  This includes the controlled and uncontrolled distances
			for which we are making calculations.  Also, it gives you a chance
			to enter the gain for each band that the antenna will be used with.
			</p><p>
			Click on "Add an antenna" to start with and enter the basic
			information.  The "Ground reflections" entry is whether or not to
			use the formula to incorporate ground reflections in the RFE
			totals.  I use it, but you should refer to Bulletin 65 for what you
			think you should do.  The controlled and uncontrolled distances are
			basically how close you and your household can get to the antenna
			and how close anyone else can get to it.
			</p><p>
			After saving the antenna, you will be prompted to add bands until
			you hit the "Cancel" button.  This allows you to set the gain for
			each band.  This gain is used in the formulas for calculating RFE.
			It should be listed as dBi, not dBd.  If your antenna specs are in
			dBd, take the dBd number and add 2.15 to it.
			</p><p>
			If you need to, you can always go back and add, delete or edit the
			bands that you have created.  When you have entered all your
			antennas, move on to the Connections tab.
			</p>
		</div>
		<div class="dynamic">
		</div>
	</div>
	<div id="connections" class="initial-noshow">
		<a class="link add-a primary-link" id="add-a-connection">Add a connection</a>
		<a class="link help" id="help-connection">Help!</a>
		<div class="help" id="help-text-connection">
			<a class="link help-hide" id="help-hide-connection">Hide help</a>
			<h2>Connections</h2>
			<p>
			The Connections tab is where you define the connections that are
			between your transmitters and your antennas.  Each
			transmitter/antenna pair can only have one connection, but each
			transmitter can connect to multiple antennas and each antenna can
			be connected to multiple transmitters, with each connection having
			different characteristics.
			</p><p>
			Things that are included in the connection properties are wire
			type, wire length, tuner losses, and any other losses (lightning
			suppressors, line splitters, etc.)  This allows you to have a wide
			range of flexibility in accurately modeling your connection setup.
			All losses are specified in dB, so be sure to enter them that way.
			If you need to add multiple losses to put in the other losses
			field, you just add the dB values together.
			</p><p>
			Currently, I only have specs on a few wire types available, but if
			you want this application to have more, feel free to send the specs
			to me and I will add them.  Just make sure that they cover a wide
			range so they can be used on lots of bands.
			</p><p>
			Add a connection for every physical connection you plan on
			modeling.  You will see a section for each connection in the
			Results tab.
			</p>
		</div>
		<div class="dynamic">
		</div>
	</div>
	<div id="results" class="initial-noshow">
		<a class="link help" id="help-results">Help!</a>
		<div class="help" id="help-text-results">
			<a class="link help-hide" id="help-hide-results">Hide help</a>
			<h2>Results</h2>
			<p>
			The Results tab is where all the results of the calculations are
			shown for each of the radio/connection/antenna groups that you have
			specified.
			</p><p>
			Listed in convenient tables, you see the data you entered in the
			first few columns and then starting with "Power at Antenna", you
			see the ERP for each band.  Then, using that number, the
			calculations show the RFE at both the controlled and uncontrolled
			distances, the minimum allowable distance for each band and then
			whether or not the band is within the limitations set by the FCC.
			</p><p>
			For each connection shown in the Results tab, and for each band
			within those connections, you should make sure that both the
			controlled and uncontrolled exposures are within the limits.  There
			is a box that will say "yes" or "no" for each entry.  If any of the
			boxes say "no", then you need to look into your setup to see what
			you can do to reduce the RF exposure for that band.  Some options
			are to: </p><ol>
			<li>Use a lower output power</li>
			<li>Use a smaller operating window (i.e. transmit for less time in
			each six or 30 minutes segments)</li>
			<li>Use a modulation that is less power (FM is 100% modulation
			whereas CW is only about 40%)</li>
			<li>Use a lower-gain antenna or a more lossy network (it would be a
			better idea to just turn down the power)</li>
			</ol>
		</div>
		<div class="dynamic">
		</div>
	</div>
	<div id="eximport" class="initial-noshow">
		<a class="link help" id="help-eximport">Help!</a>
		<div class="help" id="help-text-eximport">
			<a class="link help-hide" id="help-hide-eximport">Hide help</a>
			<h2>Import/Export</h2>
			<p>
			In the Import/Export tab, you can save your information for another
			day or copy it to send to a friend.  All the data is already stored
			in your browser (only locally&mdash;the application transmits no
			data back to the server&mdash;all the calculations and data are
			done on the client).
			</p><p>
			To export, hit the Export button and the data will all show up in a
			weird looking format that can be copied and saved in a text file.
			Then you can send it to a friend or use it later.
			</p><p>
			To import, paste exported data into the text area and hit the
			Import button.  This will try to slurp up all the data and make
			sense of it.  If something goes wrong, it should gracefully die,
			without destroying what is already on your system.
			</p><p>
			To clear all the data off your system, press the "Clear all data"
			button.  This will remove all saved settings from this application
			from your browser, allowing you to start over with a clean slate.
			</p><p>
			To view some sample data, you can click on the "Reset to sample
			data" button.  This will remove all previous settings and replace
			them with some canned settings.
			</p>
		</div>
		<div class="edit-items">
		<input id="eximport-import" type="button" name="import" value="Import"/>
		<input id="eximport-export" type="button" name="export" value="Export"/>
		<input id="eximport-reset" type="button" name="reset" value="Reset all data"/>
		<input id="eximport-sample" type="button" name="reset" value="Reset to sample data"/>
		</div>
		<textarea id="eximport-data" rows="20" cols=80"></textarea>
	</div>
	<div id="about">
		<div class="text hideme">
		<h2>Your Web Browser is Not Supported</h2>
		<p>Sorry for the inconvenience. The N7OH RFE Calculator requires just about
		anything except Internet Explorer.  Try <a href="http://www.getfirefox.com/">
		FireFox</a>, <a href="http://www.opera.com/download/">Opera</a>,
		<a href="http://www.google.com/chrome">Chrome</a>, or maybe even
		Safari.  Whatever you try, make sure it is a new browser that supports HTML 5.
		</p>
		<p>73,<br/>Vernon Mauery, N7OH</p>
		</div>
	<p>
	RF Exposure Calculator - Helping hams understand the mysteries of RF Exposure<br/>
	Copyright &copy; 2009-2010 <a href='http://vernon.mauery.com/'>Vernon Mauery</a> (N7OH)<br/>
	</p>
	<div class="text"><p>
	The idea originated from the <a
	href='http://hintlink.com/power_density.htm'>power density calculator
	written by W4/VP9KF</a>.
	I started writing my own javascript version only to find that it was
	really annoying to need to retype everything in each time I visited
	the page.  I wanted something that would store my data.  And I wanted
	to be able to share the application with others, but I didn't want to
	store <i>their</i> information.  I finally learned about local storage
	with HTML 5 and decided that I could use that for this application.
	</p><p>
	If you have questions, comments, suggestions, flames or anything else
	you would like to tell the author, please send an email: <span id="contact">[my call sign] at arrl dot net</span>
	</p>
	</div>
	<hr/>
	<tt><p>
	This program is free software: you can redistribute it and/or modify<br/>
	it under the terms of the GNU General Public License as published by<br/>
	the Free Software Foundation, either version 3 of the License, or<br/>
	(at your option) any later version.<br/>
	</p><p>
	This program is distributed in the hope that it will be useful,<br/>
	but WITHOUT ANY WARRANTY; without even the implied warranty of<br/>
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the<br/>
	GNU General Public License for more details.<br/>
	</p><p>
	You should have <a href="LICENSE">received a copy</a> of the GNU General Public License<br/>
	along with this program.  If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p></tt>
	</div>
</div>
<div class="initial-noshow">
<div id="xmtr-editor">
	<div id="xmtr-editor-msg" class="form-error"></div>
	<div class="edit-item">
		<label for="edit-xmtr-name">Name</label>
		<input type="textbox" id="edit-xmtr-name" name="name" value=""/>
	</div>
</div>
<div id="tband-editor">
	<div id="tband-editor-msg" class="form-error"></div>
	<div class="edit-item">
		<label for="edit-tband-band">Band</label>
		<select id="edit-tband-band"></select/>
	</div>
	<div class="edit-item">
		<label for="edit-tband-power">Power (W)</label>
		<input type="textbox" class="number" id="edit-tband-power" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-tband-mod">Modulation</label>
		<select id="edit-tband-mod"></select>
	</div>
	<div class="edit-item">
		<label for="edit-tband-ce">Controlled exposure (%)</label>
		<input type="textbox" class="number" id="edit-tband-ce" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-tband-ue">Uncontrolled exposure (%)</label>
		<input type="textbox" class="number" id="edit-tband-ue" value=""/>
	</div>
</div>
<div id="aband-editor">
	<div id="aband-editor-msg" class="form-error"></div>
	<div class="edit-item">
		<label for="edit-aband-band">Band</label>
		<select id="edit-aband-band"></select>
	</div>
	<div class="edit-item">
		<label for="edit-aband-gain">Gain (dBi)</label>
		<input type="textbox" class="number" id="edit-aband-gain" value=""/>
	</div>
</div>
<div id="antenna-editor">
	<div id="antenna-editor-msg" class="form-error"></div>
	<div class="edit-item">
		<label for="edit-antenna-name">Name</label>
		<input type="textbox" id="edit-antenna-name" name="name" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-antenna-cdx">Controlled exposure (ft)</label>
		<input type="textbox" class="number" id="edit-antenna-cdx" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-antenna-udx">Uncontrolled exposure (ft)</label>
		<input type="textbox" class="number" id="edit-antenna-udx" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-antenna-ground">Ground reflections</label>
		<select id="edit-antenna-ground">
			<option value="true">True</option>
			<option value="false">False</option>
		</select>
	</div>
</div>
<div id="conn-editor">
	<div id="conn-editor-msg" class="form-error"></div>
	<div class="edit-item">
		<label for="edit-conn-xmtr">Transmitter</label>
		<select id="edit-conn-xmtr"></select/>
	</div>
	<div class="edit-item">
		<label for="edit-conn-ant">Antenna</label>
		<select id="edit-conn-ant"></select/>
	</div>
	<div class="edit-item">
		<label for="edit-conn-tloss">Tuner losses (dB)</label>
		<input type="textbox" class="number" id="edit-conn-tloss" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-conn-wire">Wire type</label>
		<select id="edit-conn-wire"></select>
	</div>
	<div class="edit-item">
		<label for="edit-conn-wlen">Wire length (ft)</label>
		<input type="textbox" class="number" id="edit-conn-wlen" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-conn-other">Other losses (dB)</label>
		<input type="textbox" class="number" id="edit-conn-other" value=""/>
	</div>
</div>
</div>
</body>
</html>

