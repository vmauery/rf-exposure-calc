<!DOCTYPE HTML>
<!--
RFE_Calc is free software: you can redistribute it and/or modify it
under the terms of the GNU Lesser General Public License as  published
by the Free Software Foundation, either version 3 of the License, or (at
your option) any later version.

RFE_Calc is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public
License for more details.

You should have received a copy of the GNU Lesser General Public License
along with RFE_Calc.  If not, see <http://www.gnu.org/licenses/>.

Copyright Â© 2009-2010, Vernon Mauery (N7OH)
-->
<html><head>
  <meta charset="UTF-8">
  <meta name="keywords" content="Amateur Radio RF Safety Calculator, RF Safety, RF Calculator, RF Safety Calculator, frequency, bands, licence, radio frequency, RF, MPE">
  <meta name="description" content="Calculate RF exposures for various transmitters, antennas and other settings">
  <title>RFE Calculator</title>
  <style>
div.value {
	display: inline;
}
td.value {
	text-align: center;
}
div.transmitter, div.antenna, div.connection {
	border: 2px solid gray;
	margin: 1em;
	padding: 0em 1em .25em 1em;
}
td.compliant {
	color: green;
}
td.noncompliant {
	color: red;
}
table {
	table-layout: fixed;
}
table th {
	text-align: left;
}
table td {
	padding: 0em .5em 0em .5em;
}
table.results {
	border: 1px solid;
	font-size: 80%;
}
table.results td, table.results th {
	border: 1px solid gray;
}
table.results td {
	padding: .1em .5em 0em .5em;
}
label::after {
	content: ": ";
}
a.link {
	cursor: pointer;
}
.action-box {
	display: none;
}
div.action-box {
	float: right;
}
div.popup-bg {
	width: 100%;
	height: 100%;
	position: fixed;
	left: 0;
	top: 0;
	background-color: rgba(128,128,128,.5);
	z-index: 100;
}
div.popup {
	position: fixed;
	left: 35%;
	top: 30%;
	width: 30%;
	padding: .5em 2em 2em 2em;
	border: 1px solid black;
	background: rgba(128,128,128,1);
	z-index: 1000;
}
  </style>
  <link type="text/css" href="css/ui.all.css" rel="stylesheet" />
  <script type="text/javascript" src="js/jquery.js"></script>
  <script type="text/javascript" src="js/ui.core.js"></script>
  <script type="text/javascript" src="js/ui.tabs.js"></script>
  <script type="text/javascript" src="js/modernizr.js"></script>
  <script type="text/javascript" src="js/json2.js"></script>
  <script type="text/javascript">
<!--//
(function($) {$(function() {

const cm_per_foot = 30.48;

function array_keys(arr) {
	var ret = [];
	for (k in arr) {
		ret.push(k);
	}
	return ret;
}
function array_zip(k, v) {
	var ret = {};
	for (kk in k) {
		ret[k[kk]] = v[kk];
	}
	return ret;
}
// expects an array or associative array and uses
// key/value pairs for options, index for arrays
function select_options(list, selected) {
	var opts = "";
	for (var k in list) {
		if (k == selected) {
			select = ' selected="selected"';
		} else {
			select = '';
		}
		opts += '<option value="'+k+'"'+select+'>'+list[k]+'</option>';
	}
	return opts;
}

function TransmitterBand(xmtr, band, bandinfo) {
	/* initializer */
	this.init = function(xmtr, band, bandinfo) {
		this.id = TransmitterBand.common_id++;
		this.xmtr = xmtr;
		if ( band != null && bandinfo != null) {
			this.band = band;
			this.power = bandinfo[0];
			this.mod = bandinfo[1];
			this.ce = bandinfo[2];
			this.ue = bandinfo[3];
		}
		return true;
	};

	this.fini = function() {
		return [this.band, [this.power, this.mod, this.ce, this.ue]];
	};

	/* member functions */
	this.save = function() {
		var band = $('#edit-tband-'+this.id+'-band').attr('value') || this.band;
		var power = $('#edit-tband-'+this.id+'-power').attr('value') || this.power;
		var mod = $('#edit-tband-'+this.id+'-mod').attr('value') || this.mod;
		var ce = $('#edit-tband-'+this.id+'-ce').attr('value') || this.ce;
		var ue = $('#edit-tband-'+this.id+'-ue').attr('value') || this.ue;
		console.log('saving '+this.band+' tband, power: '+power+', modulation: '+mod+', cont exp: '+ce+', uncont exp: '+ue);
		// remove the old copy of whatever band this used to be
		// in the case of band renaming, this gets rid of the old band
		// while the assignment below saves us in the new (same?) band
		if (this.band in this.xmtr.bands) {
			delete this.xmtr.bands[this.band];
		}
		this.band = band;
		this.power = power;
		this.mod = mod;
		this.ce = ce;
		this.ue = ue;
		this.xmtr.bands[this.band] = this;
		save_transmitters();
		refresh();
	};

	this.ask_delete = function() {
		return confirm('Delete '+this.band+' band?');
	};

	this.editor = function() {
		var ret = '';
		if (this.band == null) {
			this.band = Bands[0];
			this.power = 0;
			this.mod = modulation_duty_factor[0];
			this.ce = 50;
			this.ue = 50;
			ret += '<h3>Add "'+this.xmtr.name+'" band</h3>';
		} else {
			ret += '<h3>Edit "'+this.xmtr.name+'" '+this.band+' band</h3>';
		}
		// band is a select, power is input, modulation is select, ce is input, ue is input
		var band_keys = array_keys(bands_filter(this.xmtr.bands, this.band));
		band_keys = array_zip(band_keys, band_keys);
		var mod_keys = array_keys(modulation_duty_factor);
		mod_keys = array_zip(mod_keys, mod_keys);
		ret += '<div class="edit-item"><label for="edit-tband-'+this.id+'-band">Band</label><select id="edit-tband-'+this.id+'-band">'+select_options(band_keys, this.band)+'</select/></div>';
		ret += '<div class="edit-item"><label for="edit-tband-'+this.id+'-power">Power (W)</label><input type="textbox" id="edit-tband-'+this.id+'-power" value="'+this.power+'"/></div>';
		ret += '<div class="edit-item"><label for="edit-tband-'+this.id+'-mod">Modulation</label><select id="edit-tband-'+this.id+'-mod">'+select_options(mod_keys, this.mod)+'</select></div>';
		ret += '<div class="edit-item"><label for="edit-tband-'+this.id+'-ce">Controlled exposure (%)</label><input type="textbox" id="edit-tband-'+this.id+'-ce" value="'+this.ce+'"/></div>';
		ret += '<div class="edit-item"><label for="edit-tband-'+this.id+'-ue">Uncontrolled exposure (%)</label><input type="textbox" id="edit-tband-'+this.id+'-ue" value="'+this.ue+'"/></div>';
		ret += '<div class="edit-item"><input type="submit" name="cancel" value="Cancel"/> ';
		ret += '<input type="submit" name="save" value="Save"/></div>';
		return ret;
	};
	return this.init(xmtr, band, bandinfo);
}
TransmitterBand.common_id = 0;

function Transmitter(init_data) {
	/* intializer */
	this.init = function(init_data) {
		if (init_data == null || init_data.length == 0) {
			this.name = '';
			bands = [];
		} else {
			this.name = init_data[0];
			bands = init_data[1];
		}
		this.id = Transmitter.common_id++;
		this.bands = {};
		for (band in bands) {
			var b = new TransmitterBand(this, band, bands[band]);
			this.bands[band] = b;
		}
		return true;
	};

	this.fini = function() {
		var bands = {};
		for (band in this.bands) {
			var v = this.bands[band].fini();
			bands[v[0]] = v[1];
		}
		return [this.name, bands];
	};

	/* member functions */
	this.ask_delete = function() {
		return confirm('Delete transmitter "'+this.name+'"?');
	};

	this.save = function() {
		var name = $('#edit-xmtr-'+this.id+'-name').attr('value');
		if (name != this.name) {
			this.name = name;
			console.log('saving '+this.name);
			transmitters[this.id] = this;
			save_connections();
			save_transmitters();
			refresh();
		}
	};

	this.editor = function() {
		var ret = '';
		if (this.name == "") {
			ret += '<h3>Add a transmitter</h3>';
		} else {
			ret += '<h3>Edit "'+this.name+'" transmitter</h3>';
		}
		ret += '<div class="edit-item"><label for="edit-xmtr-'+this.id+'-name">Name</label><input type="textbox" id="edit-xmtr-'+this.id+'-name" name="name" value="'+this.name+'"/></div>';
		ret += '<div class="edit-item"><input type="submit" name="cancel" value="Cancel"/> ';
		ret += '<input type="submit" name="save" value="Save"/></div>';
		return ret;
	};

	this.render = function() {
		var out = '<div class="transmitter action-popup"><div class="action-box"><a class="link add-a" id="add-a-tband-'+this.id+'">Add a band</a> | <a class="link edit-a" id="edit-a-xmtr-'+this.id+'">Edit</a> | <a class="link del-a" id="del-a-xmtr-'+this.id+'">Delete</a></div><h4>'+this.name+'</h4>\n<table width="100%">';
		out += '<tr><th width="15%">Band</th><th width="15%">Power (W)</th><th width="30%">Modulation</th><th>Controlled<br/>exposure (%)</th><th>Uncontrolled<br/>exposure (%)</th><th></th></tr>\n';
		for (var band in Bands) {
			if (!(band in this.bands)) continue;
			out += '<tr><td>'+band+'</td><td>'+this.bands[band].power+'</td><td>'+this.bands[band].mod+' ('+modulation_duty_factor[this.bands[band].mod]+'%)</td><td>'+this.bands[band].ce+'</td><td>'+this.bands[band].ue+'</td><td class="action-box"><a class="link edit-a" id="edit-a-tband-'+this.id+'-'+band+'">Edit</a> | <a class="link del-a" id="del-a-tband-'+this.id+'-'+band+'">Delete</a></td></td></tr>\n';
		}
		out += '</table></div>';
		return out;
	};

	return this.init(init_data);
}
Transmitter.common_id = 0;

function transmitter_by_name(name) {
	for (var t in transmitters) {
		if (transmitters[t].name == name)
			return transmitters[t];
	}
	return null;
}

// ant_data is [bands, cdx, udx, ground]
function Antenna(name, ant_data) {
	this.name = name;
	this.bands = ant_data[0];
	this.cdx = ant_data[1];
	this.udx = ant_data[2];
	this.ground = ant_data[3];
	this.id = Antenna.common_id++;

	this.render = function() {
		var out = '<div class="antenna action-popup"><div class="action-box"><a class="link add-a" id="add-a-aband-'+this.id+'">Add a band</a> | <a class="link del-a" id="delete-antenna-'+this.id+'">Delete antenna</a></div><h4>'+name+'</h4>\nDistances: Controlled exposure@'+this.cdx+'ft, Uncontrolled exposure@'+this.udx+'ft; Ground:'+this.ground+'<ul>';
		for (var band in this.bands) {
			out += '<li>'+band+' @ '+this.bands[band]+' dBi</li>\n';
		}
		out += '</ul></div>';
		return out;
	};
}
Antenna.common_id = 0;
function antenna_by_name(name) {
	for (var a in antennas) {
		if (antennas[a].name == name)
			return antennas[a];
	}
	return null;
}

// conn_data is [transmitter, antenna, tuner_loss, wire, length, other_loss]
function Connection(conn_data) {
	this.init = function(conn_data) {
		if (conn_data == null) {
			this.transmitter = null;
			this.antenna = null;
			this.tuner_loss = this.length = this.other_loss = 0;
			this.wire = '';
			this.name = '';
		} else {
			this.transmitter = transmitter_by_name(conn_data[0]);
			this.antenna = antenna_by_name(conn_data[1]);
			this.tuner_loss = conn_data[2];
			this.wire = conn_data[3];
			this.length = conn_data[4];
			this.other_loss = conn_data[5];
			this.name = conn_data[0] + ' <-> ' + conn_data[1];
		}
		this.id = Connection.common_id++;
		return true;
	};

	this.fini = function() {
		return [this.transmitter.name, this.antenna.name,
				this.tuner_loss, this.wire, this.length, this.other_loss];
	};

	this.ask_delete = function() {
		return confirm('Delete '+this.name+' connection?');
	};

	this.save = function() {
		var xmtr = transmitters[parseInt($('#edit-conn-'+this.id+'-xmtr').attr('value'))];
		var ant = antennas[parseInt($('#edit-conn-'+this.id+'-ant').attr('value'))];
		var tloss = $('#edit-conn-'+this.id+'-tloss').attr('value') || this.tuner_loss;
		var wire = $('#edit-conn-'+this.id+'-wire').attr('value') || this.wire;
		var wlen = $('#edit-conn-'+this.id+'-wlen').attr('value') || this.length;
		var other = $('#edit-conn-'+this.id+'-other').attr('value') || this.other_loss;
		var name = xmtr.name + ' <-> ' + ant.name;
		console.log('saving "'+name+'": tloss: '+tloss+', wire: '+wire+', length: '+wlen+', other: '+other);
		if (this.transmitter != null) {
			for (i in connections) {
				if (connections[i].transmitter.id == this.transmitter.id &&
					connections[i].antenna.id == this.antenna.id) {

					delete connections[i];
					break;
				}
			}
		}
		this.transmitter = xmtr;
		this.antenna = ant;
		this.tuner_loss = tloss;
		this.wire = wire;
		this.length = wlen;
		this.other_loss = other;
		connections.push(this);
		save_connections();
		refresh();
	};

	this.editor = function() {
		var ret = '';
		if (this.transmitter == null) {
			ret += '<h3>Add a connection</h3>';
		} else {
			ret += '<h3>Edit "'+this.name+'" connection</h3>';
		}
		var tid = this.transmitter?this.transmitter.id:null;
		var aid = this.antenna?this.antenna.id:null;
		var wire_keys = array_keys(wires);
		wire_keys = array_zip(wire_keys, wire_keys);
		ret += '<div class="edit-item"><label for="edit-conn-'+this.id+'-xmtr">Transmitter</label><select id="edit-conn-'+this.id+'-xmtr">'+select_options(this.xmtr_list(), tid)+'</select/></div>';
		ret += '<div class="edit-item"><label for="edit-conn-'+this.id+'-ant">Antenna</label><select id="edit-conn-'+this.id+'-ant">'+select_options(this.ant_list(), aid)+'</select/></div>';
		ret += '<div class="edit-item"><label for="edit-conn-'+this.id+'-tloss">Tuner losses (dB)</label><input type="textbox" id="edit-conn-'+this.id+'-tloss" value="'+this.tuner_loss+'"/></div>';
		ret += '<div class="edit-item"><label for="edit-conn-'+this.id+'-wire">Wire type</label><select id="edit-conn-'+this.id+'-wire">'+select_options(wire_keys, this.wire)+'</select></div>';
		ret += '<div class="edit-item"><label for="edit-conn-'+this.id+'-wlen">Wire length (ft)</label><input type="textbox" id="edit-conn-'+this.id+'-wlen" value="'+this.length+'"/></div>';
		ret += '<div class="edit-item"><label for="edit-conn-'+this.id+'-other">Other losses (dB)</label><input type="textbox" id="edit-conn-'+this.id+'-other" value="'+this.other_loss+'"/></div>';
		ret += '<div class="edit-item"><input type="submit" name="cancel" value="Cancel"/> ';
		ret += '<input type="submit" name="save" value="Save"/></div>';
		return ret;
	};

	this.render = function() {
		var out = '<div class="connection action-popup"><div class="action-box"><a class="link edit-a" id="edit-a-conn-'+this.id+'">Edit</a> | <a class="link del-a" id="del-a-conn-'+this.id+'">Delete</a></div><h4>\''+this.transmitter.name+'\' to \''+this.antenna.name+'\' via '+ this.length+' ft of \''+this.wire+'\'</h4>\n<ul>';
		out += '<li>Transmitter: '+this.transmitter.name+'</li>\n';
		out += '<li>Antenna: '+this.antenna.name+'</li>\n';
		out += '<li>Tuner losses: '+this.tuner_loss+'</li>\n';
		out += '<li>Wire type: '+this.wire+'</li>\n';
		out += '<li>Wire length: '+this.length+'</li>\n';
		out += '<li>Other losses: '+this.other_loss+'</li>\n';
		out += '</ul></div>';
		return out;
	};

	this.xmtr_list = function() {
		var ret = {};
		for (var t in transmitters) {
			ret[transmitters[t].id] = transmitters[t].name;
		}
		return ret;
	};

	this.ant_list = function() {
		var ret = {};
		for (var a in antennas) {
			ret[antennas[a].id] = antennas[a].name;
		}
		return ret;
	};

	return this.init(conn_data);
}
Connection.common_id = 0;

function connection_idx_from_transmitter(name) {
	conns = [];
	for (var c in connections) {
		var t = connections[c].transmitter;
		console.log('compare "'+name+'" to "'+t.name+'"');
		if (t.name == name) {
			console.log('found connection: '+connections[c].name);
			conns.push(c);
		}
	}
	return conns;
}


function popup_box(html) {
	$('body').append('<div class="popup-bg"></div><div class="popup">'+html+'</div>');
	$('.popup-bg').unbind('click').click(function(e) {
		$(this).remove();
		$('div.popup').remove();
	});
}

function add_a_thing(ele) {
	var m = $(ele).attr('id').split('-');
	var type = m[2];
	var id = parseInt(m[3]);
	var thing = null;
	switch (type) {
		case "xmtr":
			thing = new Transmitter();
			break;
		case "tband":
			thing = new TransmitterBand(transmitters[id]);
			break;
		case "antenna": type = "Antenna"; break;
		case "aband": type = "AntennaBand"; break;
		case "connection":
			thing = new Connection();
			break;
	}
	if (thing == null) return;
	popup_box(thing.editor());
	$('.popup').find(':submit[name=save]').click(function() {
		thing.save();
	});
	$('.popup').find(':submit').click(function() {
		$('.popup').remove();
		$('.popup-bg').remove();
	});
}

function edit_a_thing(ele) {
	var m = $(ele).attr('id').split('-');
	var type = m[2];
	var id = parseInt(m[3]);
	var index = m[4];
	var thing = null;
	console.log('edit_a_thing: type = '+type+', id = '+id+', index = '+index);
	switch (type) {
		case "xmtr":
			thing = transmitters[id];
			break;
		case "tband":
			thing = transmitters[id].bands[index];
			break;
		case "antenna": type = "Antenna"; break;
		case "aband": type = "AntennaBand"; break;
		case "conn":
			thing = connections[id];
			break;
	}
	if (thing == null) return;
	popup_box(thing.editor());
	$('.popup').find(':submit[name=save]').click(function() {
		thing.save();
	});
	$('.popup').find(':submit').click(function() {
		$('.popup').remove();
		$('.popup-bg').remove();
	});
}

function del_a_thing(ele) {
	var m = $(ele).attr('id').split('-');
	var type = m[2];
	var id = parseInt(m[3]);
	var index = m[4];
	var thing = null;
	console.log('del_a_thing: type = '+type+', id = '+id+', index = '+index);
	switch (type) {
		case "xmtr":
			if (transmitters[id].ask_delete()) {
				var name = transmitters[id].name;
				var conns = connection_idx_from_transmitter(name);
				for (var c in conns) {
					console.log('deleting conn '+connections[conns[c]].name);
					delete connections[conns[c]];
				}
				delete transmitters[id];
				save_transmitters();
				save_connections();
			}
			break;
		case "tband":
			if (transmitters[id].bands[index].ask_delete()) {
				delete transmitters[id].bands[index];
				save_transmitters();
			}
			break;
		case "antenna": type = "Antenna"; break;
		case "aband": type = "AntennaBand"; break;
		case "conn":
			if (connections[id].ask_delete()) {
				for (var c in connections) {
					if (connections[c].id == id) {
						console.log('deleting conn '+connections[c].name);
						delete connections[c];
					}
				}
			}
			break;
	}
	refresh();
}

function post_render() {
	$(".link").filter(".add-a").unbind('click').click(function() {
			add_a_thing(this);
	});
	$(".link").filter(".del-a").unbind('click').click(function() {
			del_a_thing(this);
	});
	$(".link").filter(".edit-a").unbind('click').click(function() {
			edit_a_thing(this);
	});
	$(".link").filter("#reset-data").unbind('click').click(function() {
		console.log('resetting data');
		reset_data_store();
	});
}

var wires = {
	'RG-8X': {'160m':0.349, '80m':0.656, '60m':0.809, '40m':0.931, '30m':1.116, '20m':1.352, '17m':1.507, '15m':1.631, '12m':1.855, '10m':1.890, '6m':2.55, '2m':4.458,},
	'RG-213/U': {'160m':0.192, '80m':0.361, '60m':0.446, '40m':0.514, '30m':0.616, '20m':0.732, '17m':0.833, '15m':0.901, '12m':1.026, '10m':1.045, '6m':1.413, '2m':2.482, },
	'LL-400': {'160m':0.2, '80m':0.22, '60m':0.28, '40m':0.3, '30m':0.35, '20m':0.40, '17m':0.45, '15m':0.54, '12m':0.6, '10m':0.67, '6m':0.88, '2m':1.52, '220 MHz':1.86, '440 MHz':2.71, '900 MHz':3.9, },
	'LL-600': {'160m':0.1, '80m':0.12, '60m':0.14, '40m':0.16, '30m':0.2, '20m':0.22, '17m':0.25, '15m':0.29, '12m':0.35, '10m':0.43, '6m':0.55, '2m':0.98, '220 MHz':1.19, '440 MHz':1.71, '900 MHz':2.5, },
	'WM CQ 551': {'160m':0.02, '80m':0.04, '60m':0.06, '40m':0.08, '30m':0.08, '20m':0.10, '17m':0.12, '15m':0.12, '12m':0.13, '10m':0.14, '6m':0.15, '2m':0.35, },
};
var Bands = {
	'160m':[1800000,2000000],
	'80m':[3500000,4000000],
	'60m':[5330000,5405000],
	'40m':[7000000,7300000],
	'30m':[10100000,10150000],
	'20m':[14000000,14350000],
	'17m':[18068000,18168000],
	'15m':[21000000,21450000],
	'12m':[24890000,24990000],
	'10m':[28000000,29700000],
	'6m':[50000000,54000000],
	'2m':[144000000,148000000],
	'220 MHz':[222000000,225000000],
	'440 MHz':[420000000,450000000],
	'900 MHz':[902000000,928000000],
	'1.2 GHz':[1240000000,1300000000],
	'2.3 GHz':[2300000000,2310000000],
	'2.4 GHz':[2390000000,2450000000],
	'3.3 GHz':[3300000000,3500000000],
	'5.6 GHz':[5650000000,5925000000],
	'10 GHz':[10000000000,10500000000],
	'24 GHz':[24000000000,24250000000],
	'47 GHz':[47000000000,47200000000],
	'76 GHz':[76000000000,81000000000],
	'122 GHz':[122250000000,123000000000],
	'134 GHz':[134000000000,141000000000],
	'241 GHz':[241000000000,250000000000],
	'275 GHz':[275000000000,300000000000],
};
function bands_filter(bands, current_band) {
	var ret = {};
	for (band in Bands) {
		if (band == current_band || !(band in bands)) {
			ret[band] = Bands[band];
		}
	}
	return ret;
}


var modulation_duty_factor = {
	'CW': 40,
	'SSB voice low': 20,
	'SSB voice high': 40,
	'FM': 100,
	'SSB AFSK': 100,
	'SSB SSTV': 100,
	'AM 50%': 50,
	'AM 100%': 25,
	'AM 0%': 100,
	'ATV': 60,
};

var transmitters = {};
var antennas = {};
var connections = [];

function save_transmitters() {
	var xmtr_data = {}
	for (var k in transmitters) {
		var v = transmitters[k].fini();
		xmtr_data[v[0]] = v[1];
	}
	setvar('transmitters', xmtr_data);
}
function load_transmitters(xmtr_data) {
	var t = {}
	for (var k in xmtr_data) {
		var nt = new Transmitter([k, xmtr_data[k]]);
		t[nt.id] = nt;
	}
	return t;
}
function load_antennas(ant_data) {
	var a = {};
	for (var k in ant_data) {
		var na = new Antenna(k, ant_data[k]);
		a[na.id] = na;
	}
	return a;
}
// connections are the only special case... here we need to look
// up the transmitter and antenna by name to get the ids to go
// in the object
function save_connections() {
	var conn_data = new Array();
	for (var k in connections) {
		conn_data.push(connections[k].fini());
	}
	setvar('connections', conn_data);
}
function load_connections(conn_data) {
	var c = [];
	for (var k in conn_data) {
		c[k] = new Connection(conn_data[k]);
	}
	return c;
}

function reset_data_store() {
	var ltransmitters = {
		// Transmitter(name, bands)
		//band info is [power, duty cycle, win_c, win_u]
		'IC-7000':{'160m':[100, 'CW', 50, 50], '80m':[100, 'CW', 50, 50], '60m':[50, 'SSB voice high', 50, 50], '40m':[100, 'SSB voice high', 50, 50], '30m':[100, 'SSB voice high', 50, 50], '20m':[100, 'SSB voice high', 50, 50], '17m':[100, 'SSB voice high', 50, 50], '15m':[100, 'SSB voice high', 50, 50], '12m':[100, 'SSB voice high', 50, 50], '10m':[100, 'SSB voice high', 50, 30], '6m':[100, 'FM', 50, 50], '2m':[50, 'FM', 50, 50], '440 MHz':[30, 'FM', 50, 50]},
		'Elecraft K3/100':{'160m':[100, 'CW', 50, 50], '80m':[100, 'CW', 50, 50], '60m':[50, 'SSB voice high', 50, 50], '40m':[100, 'SSB voice high', 50, 50], '30m':[100, 'SSB voice high', 50, 50], '20m':[100, 'SSB voice high', 50, 50], '17m':[100, 'SSB voice high', 50, 50], '15m':[100, 'SSB voice high', 50, 50], '12m':[100, 'SSB voice high', 50, 50], '10m':[100, 'SSB voice high', 50, 30]},
		'IC-92AD':{'2m':[5, 'FM', 50, 50], '440 MHz':[5, 'FM', 50, 50]},
	};
	var lantennas = {
		// Antenna(name, bands, cdx, udx, ground)
		'Center-fed Zepp':[{'80m':1.9, '60m':2.0, '40m':2.5, '30m':3.1, '20m':3.1, '17m':3.1, '15m':3.1, '12m':3.2, '10m':3.2,}, 18, 16, true],
		'6/2/440 collinear':[{'6m':3.07, '2m':8.3, '440 MHz':11.7}, 6, 15, true],
		'2/440 collinear':[{'2m':3.76, '440 MHz':4.32}, 1, 50, true],
		'2/440 dipole':[{'2m':2.2, '440 MHz':3.02}, 1, 50, true],
	};
	var lconnections = [
		// Connection(transmitter, antenna, tuner_loss, wire, length, other_loss)
		['Elecraft K3/100', 'Center-fed Zepp', 0.1, 'LL-400', 150, 0.2],
		['IC-7000', 'Center-fed Zepp', 0.1, 'RG-8X', 150, 0.2],
		['IC-7000', '6/2/440 collinear', 0.0, 'LL-400', 150, 0.2],
		['IC-92AD', '6/2/440 collinear', 0.0, 'LL-400', 150, 0.2],
		['IC-92AD', '2/440 collinear', 0.0, 'LL-400', 30.0, 0.0],
		['IC-92AD', '2/440 dipole', 0.0, 'LL-400', 30.0, 0.0],
		];
	setvar('antennas', lantennas);
	setvar('transmitters', ltransmitters);
	setvar('connections', lconnections);
	transmitters = load_transmitters(getvar('transmitters'));
	antennas = load_antennas(getvar('antennas'));
	connections = load_connections(getvar('connections'));
	refresh();
}

function refresh() {
	console.log('refresh');
try {
	 show_transmitters();
} catch (e) { console.log('transmitters failed to render'); }; try {
	 show_antennas();
} catch (e) { console.log('antennas failed to render'); }; try {
	 show_connections();
} catch (e) { console.log('connections failed to render'); }; try {
	 show_results();
} catch (e) { console.log('results failed to render'); }
	 do_interactive();
	 post_render();
}
function show_transmitters() {
	console.log('show_transmitters');
	$('#transmitters').children().remove();
	$('#transmitters').append(
		'<a class="link add-a" id="add-a-xmtr">Add a transmitter</a>\n');
	for (var t in transmitters) {
		$('#transmitters').append(transmitters[t].render());
	}
}
function show_antennas() {
	console.log('show_antennas');
	$('#antennas').children().remove();
	$('#antennas').append(
		'<a class="link add-a" id="add-a-antenna">Add an antenna</a>');
	for (var a in antennas) {
		$('#antennas').append(antennas[a].render());
	}
}
function show_connections() {
	console.log('show_connections');
	$('#connections').children().remove();
	$('#connections').append(
		'<a class="link add-a" id="add-a-connection">Add a connection</a>');
	for (var c in connections) {
		$('#connections').append(connections[c].render());
	}
}
function show_results() {
	console.log('show_results');
	$('#results').children().remove();
	for (var c in connections) {
		var con = connections[c];
		var tm = con.transmitter;
		var ant = con.antenna;
		ctable = '<h3>\''+tm.name+'\' to \''+ant.name+'\' via '+ con.length+' ft of \''+con.wire+'\'</h3><div>Controlled distance: '+ant.cdx+' ft., Uncontrolled distance: '+ant.udx+' ft</div>';
		ctable += '<table class="results"><tr><th rowspan="2">Band</th><th rowspan="2">Power (W)</th><th rowspan="2">Tuner Losses (dB)</th><th rowspan="2">Line Losses (dB)</th><th rowspan="2">Other Losses (dB)</th><th rowspan="2">Antenna Gain (dBi)</th><th rowspan="2">Power at Antenna (W)</th><th colspan="4">Controlled Exposure</th><th colspan="4">Uncontrolled Exposure</th></tr>\n';
		ctable += '<tr><th>MPE (mW/cm<sup>2</sup>)</th><th>RF Exposure (mW/cm<sup>2</sup>)</th><th>Minimum Distance (ft)</th><th>Distance OK</th><th>MPE (mW/cm<sup>2</sup>)</th><th>RF Exposure (mW/cm<sup>2</sup>)</th><th>Minimum Distance (ft)</th><th>Distance OK</th></tr>\n';
		for (var b in Bands) {
			if (!(b in tm.bands) || ant.bands[b] == null) continue;
			var band = tm.bands[b];
			var freq = Bands[b][1];
			var line_loss = (con.length/100.0)*wires[con.wire][b];
			if (wires[con.wire][b] == null) {
				alert("Wire '"+con.wire+"' has no loss info at "+b);
				line_loss = 0;
			}
			var tloss = con.tuner_loss + con.other_loss + line_loss;
			tloss = Math.pow(10, -(tloss/10.0));
			var gain = Math.pow(10, ant.bands[b]/10.0);
			results = '<tr>';
			// calculate rfe/mpe/mdx for transmitter power at band with connection losses
			ce = calc_exposure(true, band.power, modulation_duty_factor[band.mod]/100.0, band.ce/100.0, tloss, gain, freq, ant.cdx*cm_per_foot, ant.ground);
			ue = calc_exposure(false, band.power, modulation_duty_factor[band.mod]/100.0, band.ue/100.0, tloss, gain, freq, ant.udx*cm_per_foot, ant.ground);
			results += '<td>'+b+'</td><td>'+band.power+'</td><td>'+con.tuner_loss+'</td>';
			results += '<td>'+line_loss.toPrecision(4)+'</td><td>'+con.other_loss+'</td>';
			results += '<td>'+ant.bands[b].toPrecision(4)+'</td>';
			results += '<td>'+(band.power*tloss*gain).toPrecision(4)+'</td>';
			// controlled exposure
			results += '<td>'+ce.mpe.toPrecision(4)+'</td>';
			results += '<td>'+ce.rfe.toPrecision(4)+'</td>';
			results += '<td>'+(ce.mdx/cm_per_foot).toPrecision(4)+'</td>';
			results += '<td class="'+(ce.rfe < ce.mpe ? '':'non')+'compliant">'+(ce.rfe < ce.mpe ? 'Yes':'No')+'</td>';
			// uncontrolled exposure
			results += '<td>'+ue.mpe.toPrecision(4)+'</td>';
			results += '<td>'+ue.rfe.toPrecision(4)+'</td>';
			results += '<td>'+(ue.mdx/cm_per_foot).toPrecision(4)+'</td>';
			results += '<td class="'+(ue.rfe < ue.mpe ? '':'non')+'compliant">'+(ue.rfe < ue.mpe ? 'Yes':'No')+'</td>';
			results += '</tr>';
			ctable += results;
		}
		$('#results').append(ctable);
	}
// | transmitter | power | band | tuner losses | line losses | other losses | rfe | mpe | mdx | ok
}
function export_data() {
}
function import_data() {
}
function calc_mpe(frequency, controlled) {
	frequency /= 1000000;
	if (frequency < 1.34) {
		return 100.0;
	}  /**  Below 1.34 MHz  **/
	else if (frequency < 3.0) {
		if (controlled) return 100.0;
		return 180.0 / (Math.pow(frequency,2));
	}  /**  Below 3.0 MHz  **/
	else if (frequency < 30.0) {
		if (controlled) return 900.0 / Math.pow(frequency,2);
		return 180.0 / (Math.pow(frequency,2));
	}  /**  Below 30 MHz  **/
	else if (frequency < 300.0) {
		if (controlled) return 1.0;
		return 0.2;
	}  /**  Below 300 MHz  **/
	else if (frequency < 1500.0) {
		if (controlled) return frequency / 300.0
			return frequency / 1500.0;
	}  /**  Below 1500 MHz  **/
	else if (frequency < 100000.0) {
		if (controlled) return 5.0;
		return 1.0;
	}  /**  Below 100 GHz  **/
	else {  /**  Frequency too high  **/
		alert("The FCC does not have exposure limits above 100 GHz.\nPlease try again.");
		return;
	}  /**  Frequency too high  **/
}
/* inputs:
  @controlled: this is controlled or uncontrolled (bool)
  @watts: max watts at transmitter
  @tdc: transmission duty cycle (~20% for voice, ~40% for CW)
  @winave: average window x/6 for controlled, x/30 for controlled
  @tloss: total losses from transmitter to antenna (fraction, not in dB)
  @gain: antenna gain (fraction, not in dB)
  @dx: distance from center of antenna in cm
  @ground: calculate ground reflections (bool)
  returns:
  @pd: power density
  @mpe: maximum permissible exposure
  @dxm: minimum distance to compliance in cm
*/
function calc_exposure(controlled, watts, tdc, winave, tloss, gain, freq, dx, ground) {
	var power = tdc * tloss * watts * 1000 * winave * gain;
	var rfe, mpe, mdx;
	if ((power > 0) && (dx > 0)) {
		if (ground)
			gf = 0.64;
		else
			gf = 0.25;
		rfe = (gf * power) / (Math.PI * Math.pow(dx,2));
		mpe = calc_mpe(freq, controlled);
		mdx = Math.sqrt((gf * power)/(mpe * Math.PI));
	}
	//alert("{rfe:"+rfe+", mpe:"+mpe+", mdx:"+mdx+"}");
	return {rfe:rfe, mpe:mpe, mdx:mdx};
}
function hide_elements(ele) {
	$(ele).children().filter('.action-box').hide();
}
function do_interactive() {
	$('.action-popup').hover(function() {
		$(this).find('.action-box').show();
	}, function() {
		$(this).find('.action-box').hide();
	});
}
function setvar(name, value) {
	window.localStorage['rfe.'+name] = JSON.stringify(value);
}
function getvar(name, default_value) {
	var v = window.localStorage['rfe.'+name];
	if (v == null)
		return default_value;
	return JSON.parse(v);
}

 $("#tabs").tabs();
 if (!Modernizr.localstorage) {
  alert('Your browser does not have local storage\nThis means that you will not be able to save\nany of your changes.');
 }

 transmitters = load_transmitters(getvar('transmitters', []));
 antennas = load_antennas(getvar('antennas', []));
 connections = load_connections(getvar('connections', []));
 refresh();

}); })(jQuery);

-->
  </script>
</head><body bgcolor="#ffffff" text="#000000">

<div id="tabs">
    <ul>
        <li><a href="#transmitters"><span>Transmitters</span></a></li>
        <li><a href="#antennas"><span>Antennas</span></a></li>
        <li><a href="#connections"><span>Connections</span></a></li>
        <li><a href="#results"><span>Results</span></a></li>
		<li><a href="#eximport"><span>Import/Export</span></a></li>
		<li><a href="#help"><span>Help</span></a></li>
    </ul>
    <div id="transmitters">
    </div>
    <div id="antennas">
    </div>
    <div id="connections">
    </div>
    <div id="results">
    </div>
    <div id="eximport">
        <textarea rows="25" cols=100">
        Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat.
        Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat.
		</textarea>
    </div>
	<div id="help">
	<p><a class="link" id="reset-data">Reset data</a></p>
	<h2>Transmitters</h2>
	<h2>Antennas</h2>
	<h2>Connections</h2>
	<h2>Results</h2>
	<h2>Import/Export</h2>
	<h2>About</h2>
	<p>
	RFE Calculator - A tool to help hams figure out the mysteries of RFE<br/>
    Copyright &copy; 2009-2010 Vernon Mauery (N7OH)<br/>
	</p><p>
    This program is free software: you can redistribute it and/or modify<br/>
    it under the terms of the GNU General Public License as published by<br/>
    the Free Software Foundation, either version 3 of the License, or<br/>
    (at your option) any later version.<br/>
	</p><p>
    This program is distributed in the hope that it will be useful,<br/>
    but WITHOUT ANY WARRANTY; without even the implied warranty of<br/>
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the<br/>
    GNU General Public License for more details.<br/>
	</p><p>
    You should have <a href="LICENSE">received a copy</a> of the GNU General Public License<br/>
    along with this program.  If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p>
	</div>
</div>

</body>
</html>

