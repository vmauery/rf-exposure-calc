<!DOCTYPE HTML>
<!--
RFE_Calc is free software: you can redistribute it and/or modify it
under the terms of the GNU Lesser General Public License as  published
by the Free Software Foundation, either version 3 of the License, or (at
your option) any later version.

RFE_Calc is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public
License for more details.

You should have received a copy of the GNU Lesser General Public License
along with RFE_Calc.  If not, see <http://www.gnu.org/licenses/>.

Copyright Â© 2009-2014, Vernon Mauery (N7OH)
-->
<html><head>
<meta charset="UTF-8">
<meta name="keywords" content="Amateur Radio RF Safety Calculator, RF Safety, RF Exposure Calculator, RF Safety Calculator, RFE, MPE, RFE Calculator">
<meta name="description" content="Calculate RF exposures for various transmitters, antennas and other settings">
<title>N7OH RF Exposure Calculator</title>
<link type="text/css" href="css/jquery-ui.css" rel="stylesheet" />
<style>
div.value {
	display: inline;
}
td.value {
	text-align: center;
}
div.transmitter, div.antenna, div.connection {
	border: 2px solid gray;
	margin: 1em;
	padding: 0em 1em .25em 1em;
}
td.compliant {
	color: green;
}
td.noncompliant {
	color: red;
}
table {
	table-layout: fixed;
}
.error {
	color: red;
}
h4 {
	font-size: 110%;
	margin-top: 0.5em;
	margin-bottom: 0;
}
table th {
	text-align: left;
	font-size: 90%;
}
table td {
	padding: 0em .5em 0em .5em;
}
table.results {
	border: 1px solid;
	font-size: 80%;
	border-collapse: collapse;
}
table.results th {
	border-bottom: 1px solid gray;
	padding: 0.1em 0.5em 0em 0.5em;
	background-color: #d0d0d0;
}
table.results td {
	border-bottom: 1px solid gray;
	padding: 0.1em 0.5em 0em 0.5em;
}
table.results tr.res-row:hover {
	background-color: #e0e0e0;
}
.nowrap {
	white-space: nowrap;
}
.left-border {
	border-left: 1px solid gray;
}
label:after {
	content: ": ";
}
a.add-a, a.edit-a, a.del-a {
	border-bottom: 1px dotted gray;
}
a.primary-link {
	font-size: 120%;
	font-weight: bold;
}
a.link {
	cursor: pointer;
}
.action-box {
	display: none;
}
div.action-box {
	float: right;
}
div.help {
	display: none;
	border: 2px solid gray;
	margin: 1em;
	padding: 0.5em;
}
.help > h2 {
	margin-top: .1em;
	clear: none;
}
a.help-hide {
	color: #0aad0a;
	float: right;
}
a.help {
	color: #cd0a0a;
	float: right;
}
div.text {
	width: 600px;
}
input.number {
	width: 4em;
}
.form-error {
	border: 1px solid #cd0a0a; /* this needs to match the ui-state-error class */
	padding: 0.3em;
	display: none;
	margin-bottom: 0.8em;
}
.initial-noshow {
	display: none;
}
.custom-combobox {
	position: relative;
	display: inline-block;
}
.custom-combobox-toggle {
	position: absolute;
	top: 0;
	bottom: 0;
	margin-left: -1px;
	padding: 0;
	/* support: IE7 */
	*height: 1.5em;
	*top: 0.1em;
}
.custom-combobox-input {
	margin: 0;
}
</style>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery-ui.js"></script>
<script type="text/javascript">
<!--//
(function($) {
		$.widget( "ui.combobox", {
			widgetEventPrefix: "combobox",

			_create: function() {
				this.wrapper = $( "<span>" )
					.addClass( "custom-combobox" )
					.insertAfter( this.element.hide() );

				this._createAutocomplete();
				this._createShowAllButton();
				this._validityCheck = null;
			},

			_createAutocomplete: function() {
				var selected = this.element.children( ":selected" ),
					value = selected.val() ? selected.text() : "";

				this.input = $( "<input>" )
					.appendTo( this.wrapper )
					.val( value )
					.removeAttr( "title", "" )
					.addClass( "custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-left" )
					.autocomplete({
						delay: 0,
						minLength: 0,
						source: $.proxy( this, "_source" )
					});

				this._on( this.input, {
					autocompleteselect: function( event, ui ) {
						ui.item.option.selected = true;
						this._trigger( "select", event, {
							item: ui.item.option
						});
					},

					autocompletechange: "_newIfNotFound"
				});
			},

			_createShowAllButton: function() {
				var input = this.input,
					wasOpen = false;

				$( "<a>" )
					.prop( "tabIndex", -1 )
					.prop( "title", "Show All Items" )
					.appendTo( this.wrapper )
					.button({
						icons: {
							primary: "ui-icon-triangle-1-s"
						},
						text: false
					})
					.removeClass( "ui-corner-all" )
					.addClass( "custom-combobox-toggle ui-corner-right" )
					.mousedown(function() {
						wasOpen = input.autocomplete( "widget" ).is( ":visible" );
					})
					.click(function() {
						input.focus();

						// Close if already visible
						if ( wasOpen ) {
							return;
						}

						// Pass empty string as value to search for, displaying all results
						input.autocomplete( "search", "" );
					});
			},

			_source: function( request, response ) {
				var matcher = new RegExp( $.ui.autocomplete.escapeRegex(request.term), "i" );
				response( this.element.children( "option" ).map(function() {
					var text = $( this ).text();
					if ( this.value && ( !request.term || matcher.test(text) ) )
						return {
							label: text,
							value: text,
							option: this
						};
				}) );
			},

			_removeIfInvalid: function( event, ui ) {

				// Selected an item, nothing to do
				if ( ui.item ) {
					return;
				}

				// Search for a match (case-insensitive)
				var value = this.input.val(),
					valueLowerCase = value.toLowerCase(),
					valid = false;
				this.element.children( "option" ).each(function() {
					if ( $( this ).text().toLowerCase() === valueLowerCase ) {
						this.selected = valid = true;
						return false;
					}
				});

				// Found a match, nothing to do
				if ( valid ) {
					return;
				}

				// Remove invalid value
				this.input
					.val( "" )
					.prop( "title", value + " didn't match any item" );
				this.element.val( "" );
				this.input.data( "ui-autocomplete" ).term = "";
			},

			_newIfNotFound: function( event, ui ) {

				// Selected an item, nothing to do
				if ( ui.item ) {
					return;
				}

				// Search for a match (case-insensitive)
				var value = this.input.val(),
					valueLowerCase = value.toLowerCase(),
					valid = false;
				this.element.children( "option" ).each(function() {
					if ( $( this ).text().toLowerCase() === valueLowerCase ) {
						this.selected = valid = true;
						return false;
					}
				});

				// Found a match, nothing to do
				if ( valid ) {
					return;
				}

				// Remove invalid value
				if (this._validityCheck != null) {
					if ((typeof this._validityCheck === "function") &&
							this._validityCheck.apply(null, [value]) == null) {
						return this._removeIfInvalid(event, ui);
					}
				}

				this.input.val( value );
				this.element.val( value );
				this.input.data( "ui-autocomplete" ).term = value;
				//  console.log("keeping combobox value as '"+value+"'");
			},

			val: function ( newVal ) {
				if (!arguments.length) {
					var value = this.input.val();
					selected = this.element.children(":selected");
					if (selected.length > 0)
						return selected.val();
					return value;
				}

				var valid = false;
				this.element.prop('selectedIndex', -1);
				this.element.children('option').each(function() {
						if ( this.value == newVal ) {
						this.selected = valid = true;
						return false;
						}
					});

				if ( valid ) {
					this.input.val(this.element.children(':selected').text());
				} else {
					this.input.val( "" );
					this.element.prop('selectedIndex', -1);
				}

			},

			validityCheck: function ( checker ) {
				this._validityCheck = checker;
			},

			_destroy: function() {
				this.wrapper.remove();
				this.element.show();
			}
		});

$(function() {

if (!window.console) {
	window.console = {};
	window.console.log = function() {};
	window.console.error = function() {};
}

cm_per_foot = 30.48;

function callback(fnstr) {
	arguments.pop();
	if (fnstr in window) {
		fn = window[fnstr];
		if (typeof fn === "function") {
			return fn.apply(null, arguments);
		}
	}
	return null;
}

function log_err(msg, e) {
	console.error(msg + ': '+e.stack);
}

function is_numeric(v) {
	return !isNaN(v) && isFinite(v);
}

function array_size(arr) {
	var ret = 0;
	for (var k in arr) {
		ret++;
	}
	return ret;
}
function array_keys(arr) {
	var ret = [];
	for (k in arr) {
		ret.push(k);
	}
	return ret;
}
function array_zip(k, v) {
	var ret = {};
	for (kk in k) {
		ret[k[kk]] = v[kk];
	}
	return ret;
}
function band_to_frequency(band) {
	if (band in Bands) {
		return (Bands[band][1] + Bands[band][0])/2.0;
	}
	bre = /^([\d.]+)\s*([cmnu]?m|[kmgt]?hz|[kmgt]?c)?$/i;
	matches = bre.exec(band);
	if (matches == null || matches.length < 3 || !is_numeric(matches[1])) {
		return null;
	}
	var val = parseFloat(matches[1]);
	if (matches[2] == undefined) {
		return val;
	}

	suffix = matches[2].toLowerCase();
	if (suffix[suffix.length-1] == 'm') {
		var c = 299792458;
		if (suffix == 'cm') {
			c *= 100;
		} else if (suffix == 'mm') {
			c *= 1000;
		} else if (suffix == 'um') {
			c *= 1000000;
		} else if (suffix == 'nm') {
			c *= 1000000000;
		}
		return c / val;
	}

	var m = 1;
	if (suffix == 'khz' || suffix == 'kc') {
		m = 1000;
	} else if (suffix == 'mhz' || suffix == 'mc') {
		m = 1000000;
	} else if (suffix == 'ghz' || suffix == 'gc') {
		m = 1000000000;
	} else if (suffix == 'thz' || suffix == 'tc') {
		m = 1000000000000;
	}
	return m*val;
}
// expects an array or associative array and uses
// key/value pairs for options, index for arrays
function select_options(list, selected) {
	var opts = "";
	for (var k in list) {
		if (k == selected) {
			select = ' selected="selected"';
		} else {
			select = '';
		}
		opts += '<option value="'+k+'"'+select+'>'+list[k]+'</option>';
	}
	return opts;
}

function TransmitterBand(xmtr, band, bandinfo) {
	/* initializer */
	this.init = function(xmtr, band, bandinfo) {
		this.id = TransmitterBand.common_id++;
		this.xmtr = xmtr;
		if ( band != null && bandinfo != null) {
			this.band = band;
			this.power = bandinfo[0];
			this.mod = bandinfo[1];
			this.ce = bandinfo[2];
			this.ue = bandinfo[3];
		} else {
			this.band = '';
			this.power = 100;
			var mods = array_keys(modulation_duty_factor);
			this.mod = mods[0];
			this.ce = 50;
			this.ue = 100;
		}
		return true;
	};

	this.fini = function() {
		return [this.band, [this.power, this.mod, this.ce, this.ue]];
	};

	/* member functions */
	this.save = function() {
		var band = $('#edit-tband-band').combobox('val');
		var power = parseFloat($('#edit-tband-power').val());
		var mod = $('#edit-tband-mod').val();
		var ce = parseFloat($('#edit-tband-ce').val());
		var ue = parseFloat($('#edit-tband-ue').val());
		var msg;
		if (band_to_frequency(band) == null) {
			msg = 'Invalid Band: try X MHz, Nm, ABCD, etc.';
			form_message($('#tband-editor-msg'),
				msg, $('#edit-tband-tband')
			);
			return false;
		}
		if (!is_numeric(power) || power <= 0) {
			if (!is_numeric(power))
				msg = 'Transmitter power must be numeric';
			else
				msg = 'Transmitter power must be > 0';
			form_message($('#tband-editor-msg'),
				msg, $('#edit-tband-power')
			);
			return false;
		}
		if (!is_numeric(ce) || (ce <= 0 || ce > 100)) {
			if (!is_numeric(ce))
				msg = 'Controlled exposure must be numeric';
			else
				msg = 'Controlled exposure must be between 1 and 100%';
			form_message($('#tband-editor-msg'),
				msg, $('#edit-tband-ce')
			);
			return false;
		}
		if (!is_numeric(ue) || (ue <= 0 || ue > 100)) {
			if (!is_numeric(ue))
				msg = 'Uncontrolled exposure must be numeric';
			else
				msg = 'Uncontrolled exposure must be between 1 and 100%';
			form_message($('#tband-editor-msg'),
				msg, $('#edit-tband-ue')
			);
			return false;
		}
		// console.log('saving '+this.band+' tband, band: '+band+', power: '+power+', modulation: '+mod+', cont exp: '+ce+', uncont exp: '+ue);
		// remove the old copy of whatever band this used to be
		// in the case of band renaming, this gets rid of the old band
		// while the assignment below saves us in the new (same?) band
		if (this.band in this.xmtr.bands) {
			delete this.xmtr.bands[this.band];
		}
		this.band = band;
		this.power = power;
		this.mod = mod;
		this.ce = ce;
		this.ue = ue;
		this.xmtr.bands[this.band] = this;
		save_transmitters();
		refresh();
		return true;
	};

	this.ask_delete = function() {
		return confirm('Delete '+this.band+' band?');
	};

	this.editor = function(next) {
		// set the title
		var title;
		if (this.band == "") {
			title = 'Add a band on "'+this.xmtr.name+'"';
		} else {
			title = 'Edit '+this.band+' band  on "'+this.xmtr.name+'"';
		}
		// band is a select, power is input, modulation is select, ce is input, ue is input
		var band_keys = array_keys(bands_filter(this.xmtr.bands, this.band));
		band_keys = array_zip(band_keys, band_keys);
		var mod_keys = array_keys(modulation_duty_factor);
		mod_keys = array_zip(mod_keys, mod_keys);
		$('#edit-tband-band').empty().append(select_options(band_keys, this.band));
		$('#edit-tband-mod').empty().append(select_options(mod_keys, this.mod));
		// set the field values
		$('#edit-tband-band').combobox().combobox('validityCheck', band_to_frequency);
		$('#edit-tband-band').combobox('val', this.band);
		$('#edit-tband-power').val(this.power);
		$('#edit-tband-mod').val(this.mod);
		$('#edit-tband-ce').val(this.ce);
		$('#edit-tband-ue').val(this.ue);
		// set the buttons to reflect this object
		var thing = this;
		$('#tband-editor').dialog('option', {
			'buttons': {
				'Save':function() {
					TransmitterBand.reset_form_errors();
					if (thing.save()) {
						$(this).dialog('close');
						if (next != null) {
							add_a_thing(null, next);
						}
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
				},
			},
			'title': title,
		});
		$('#tband-editor').dialog('open');
	};
	return this.init(xmtr, band, bandinfo);
}
TransmitterBand.reset_form_errors = function() {
	$('#edit-tband-power').removeClass('ui-state-error');
	$('#edit-tband-ce').removeClass('ui-state-error');
	$('#edit-tband-ue').removeClass('ui-state-error');
};
TransmitterBand.common_id = 0;

function Transmitter(init_data) {
	/* intializer */
	this.init = function(init_data) {
		if (init_data == null || init_data.length == 0) {
			this.name = '';
			bands = [];
		} else {
			this.name = init_data[0];
			bands = init_data[1];
		}
		this.id = Transmitter.common_id++;
		this.bands = {};
		for (band in bands) {
			var b = new TransmitterBand(this, band, bands[band]);
			this.bands[band] = b;
		}
		return true;
	};

	this.fini = function() {
		var bands = {};
		for (var band in this.bands) {
			// console.log("saving "+this.name+": "+band);
			var v = this.bands[band].fini();
			bands[v[0]] = v[1];
		}
		return [this.name, bands];
	};

	/* member functions */
	this.ask_delete = function() {
		return confirm('Delete transmitter "'+this.name+'"?');
	};

	this.save = function() {
		var name = $('#edit-xmtr-name').val();
		var samename = transmitter_by_name(name);
		if (samename != null && samename.id != this.id) {
			form_message($('#xmtr-editor-msg'),
				'Transmitter names must be unique',
				$('#edit-xmtr-name')
			);
			return false;
		}
		if (name != this.name) {
			this.name = name;
			// console.log('saving '+this.name);
			transmitters[this.id] = this;
			save_connections();
			save_transmitters();
			refresh();
		}
		return true;
	};

	this.editor = function(next) {
		// set the title
		var title;
		if (this.name == "") {
			title = 'Add a transmitter';
		} else {
			title = 'Edit transmitter "'+this.name+'"';
		}
		// set the field values
		$('#edit-xmtr-name').val(this.name);
		// set the buttons to reflect this object
		var thing = this;
		$('#xmtr-editor').dialog('option', {
			'buttons': {
				'Save':function() {
					Transmitter.reset_form_errors();
					if (thing.save()) {
						$(this).dialog('close');
						if (next != null) {
							add_a_thing(null, next);
						}
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
				},
			},
			'title': title,
		});
		$('#xmtr-editor').dialog('open');
	};

	this.render = function() {
		var out = '<div class="transmitter action-popup"><div class="action-box">';
		out += '<a class="link add-a" id="add-a-tband-'+this.id+'">Add a band</a> | ';
		out += '<a class="link edit-a" id="edit-a-xmtr-'+this.id+'">Edit</a> |';
		out += '<a class="link del-a" id="del-a-xmtr-'+this.id+'">Delete</a>';
		out += '</div>';
		out += '<h4>'+this.name+'</h4>\n<table width="100%"><tr>';
		out += '<th width="15%">Band</th>';
		out += '<th width="15%">Power (W)</th>';
		out += '<th width="30%">Modulation</th>';
		out += '<th>Controlled<br/>exposure (%)</th>';
		out += '<th>Uncontrolled<br/>exposure (%)</th>';
		out += '<th></th>';
		out += '</tr>\n';
		t_bands = {};
		for (var b in this.bands) {
			var bf = band_to_frequency(b);
			t_bands[bf] = b;
		}
		for (var f in t_bands) {
			var band = t_bands[f];
			out += '<tr><td>'+band+'</td>';
			out += '<td>'+this.bands[band].power+'</td>';
			out += '<td>'+this.bands[band].mod+' ('+modulation_duty_factor[this.bands[band].mod]+'%)</td>';
			out += '<td>'+this.bands[band].ce+'</td>';
			out += '<td>'+this.bands[band].ue+'</td>';
			out += '<td class="action-box">';
			out += '<a class="link edit-a" id="edit-a-tband-'+this.id+'-'+band+'">Edit</a> |';
			out += '<a class="link del-a" id="del-a-tband-'+this.id+'-'+band+'">Delete</a>';
			out += '</td></tr>\n';
		}
		if (array_size(this.bands) == 0) {
			var msg = 'This transmitter does not yet have bands defined.  Please click on "Add a band".';
			out += '<tr><td colspan="6" class="error">'+msg+'</td></tr>';
		}
		out += '</table></div>';
		return out;
	};

	return this.init(init_data);
}
Transmitter.reset_form_errors = function() {
	$('#edit-xmtr-name').removeClass('ui-state-error');
};
Transmitter.common_id = 0;

function transmitter_by_name(name) {
	for (var t in transmitters) {
		if (transmitters[t].name == name)
			return transmitters[t];
	}
	return null;
}

function AntennaBand(ant, band, gain) {
	/* initializer */
	this.init = function(ant, band, gain) {
		this.id = AntennaBand.common_id++;
		this.antenna = ant;
		this.band = band || '';
		this.gain = gain || 2.15;
		return true;
	};

	this.fini = function() {
		return [this.band, this.gain];
	};

	/* member functions */
	this.save = function() {
		var band = $('#edit-aband-band').combobox('val');
		var gain = parseFloat($('#edit-aband-gain').val());
		if (!is_numeric(gain)) {
			form_message($('#aband-editor-msg'),
				'Gain must be numeric',
				$('#edit-aband-gain')
			);
			return false;
		}
		// console.log('saving '+band+' aband, gain: '+gain);
		// remove the old copy of whatever band this used to be
		// in the case of band renaming, this gets rid of the old band
		// while the assignment below saves us in the new (same?) band
		if (this.band in this.antenna.bands) {
			delete this.antenna.bands[this.band];
		}
		this.band = band;
		this.gain = gain;
		this.antenna.bands[this.band] = this;
		save_antennas();
		refresh();
		return true;
	};

	this.ask_delete = function() {
		return confirm('Delete '+this.band+' band?');
	};

	this.editor = function(next) {
		// set the title
		var title;
		if (this.band == "") {
			title = 'Add a band on "'+this.antenna.name+'"';
		} else {
			title = 'Edit '+this.band+' band  on "'+this.antenna.name+'"';
		}
		// band is a select, gain is input
		var band_keys = array_keys(bands_filter(this.antenna.bands, this.band));
		band_keys = array_zip(band_keys, band_keys);
		$('#edit-aband-band').empty().append(select_options(band_keys, this.band));
		// set the field values
		$('#edit-aband-band').combobox().combobox('validityCheck', band_to_frequency);
		$('#edit-aband-band').combobox('val', this.band);
		$('#edit-aband-gain').val(this.gain);
		// set the buttons to reflect this object
		var thing = this;
		$('#aband-editor').dialog('option', {
			'buttons': {
				'Save':function() {
					AntennaBand.reset_form_errors();
					if (thing.save()) {
						$(this).dialog('close');
						if (next != null) {
							add_a_thing(null, next);
						}
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
				},
			},
			'title': title,
		});
		$('#aband-editor').dialog('open');
	};
	return this.init(ant, band, gain);
}
AntennaBand.reset_form_errors = function() {
	$('#edit-aband-gain').removeClass('ui-state-error');
};
AntennaBand.common_id = 0;

// ant_data is [bands, cdx, udx, ground]
function Antenna(name, ant_data) {
	this.init = function(name, ant_data) {
		this.id = Antenna.common_id++;
		this.bands = {};
		if (name == null) {
			this.name = '';
			this.cdx = 0;
			this.udx = 0;
			this.ground = true;
		} else {
			this.name = name;
			this.bands = {};
			for (b in ant_data[0]) {
				this.bands[b] = new AntennaBand(this, b, ant_data[0][b]);
			}
			this.cdx = ant_data[1];
			this.udx = ant_data[2];
			this.ground = ant_data[3];
		}
		return true;
	};

	this.fini = function() {
		var bands = {};
		for (var band in this.bands) {
			var v = this.bands[band].fini();
			bands[v[0]] = v[1];
		}
		return [this.name, [bands, this.cdx, this.udx, this.ground]];
	};

	this.ask_delete = function() {
		return confirm('Delete antenna "'+this.name+'"?');
	};

	this.save = function() {
		var name = $('#edit-antenna-name').val();
		var cdx = parseFloat($('#edit-antenna-cdx').val());
		var udx = parseFloat($('#edit-antenna-udx').val());
		var ground = $('#edit-antenna-ground').val();
		ground = (ground == 'false')?false:true;
		var samename = antenna_by_name(name);
		if (samename != null && samename.id != this.id) {
			form_message($('#antenna-editor-msg'),
				'Antenna names must be unique',
				$('#edit-antenna-name')
			);
			return false;
		}
		var msg;
		if (!is_numeric(cdx) || cdx <= 0) {
			if (!is_numeric(cdx))
				msg = 'Controlled distance must be numeric';
			else
				msg = 'Controlled distance must be > 0';
			form_message($('#antenna-editor-msg'),
				msg, $('#edit-antenna-cdx')
			);
			return false;
		}
		if (!is_numeric(udx) || udx <= 0) {
			if (!is_numeric(udx))
				msg = 'Uncontrolled distance must be numeric';
			else
				msg = 'Uncontrolled distance must be > 0';
			form_message($('#antenna-editor-msg'),
				msg, $('#edit-antenna-udx')
			);
			return false;
		}
		// console.log('saving "'+this.name+'" antenna, cdx: '+cdx+', udx: '+udx+', ground: '+ground);
		this.name = name;
		this.cdx = cdx;
		this.udx = udx;
		this.ground = ground;
		antennas[this.id] = this;
		save_connections();
		save_antennas();
		refresh();
		return true;
	};

	this.editor = function(next) {
		// set the title
		var title;
		if (this.name == "") {
			title = 'Add an antenna';
		} else {
			title = 'Edit antenna "'+this.name+'"';
		}
		// set the field values
		$('#edit-antenna-name').val(this.name);
		$('#edit-antenna-cdx').val(this.cdx);
		$('#edit-antenna-udx').val(this.udx);
		$('#edit-antenna-ground').val(this.ground);
		// set the buttons to reflect this object
		var thing = this;
		$('#antenna-editor').dialog('option', {
			'buttons': {
				'Save':function() {
					Antenna.reset_form_errors();
					if (thing.save()) {
						$(this).dialog('close');
						if (next != null) {
							add_a_thing(null, next);
						}
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
				},
			},
			'title': title,
		});
		$('#antenna-editor').dialog('open');
	};

	this.render = function() {
		var out = '<div class="antenna action-popup"><div class="action-box">';
		out += '<a class="link add-a" id="add-a-aband-'+this.id+'">Add a band</a> |';
		out += '<a class="link edit-a" id="edit-a-antenna-'+this.id+'">Edit</a> |';
		out += '<a class="link del-a" id="del-a-antenna-'+this.id+'">Delete</a>';
		out += '</div>';
		out += '<h4>'+this.name+'</h4>\n';
		out += 'Controlled exposure: '+this.cdx+'ft, Uncontrolled exposure: '+this.udx+'ft, Ground reflections: '+this.ground+'\n';
		out += '<table width="100%"><tr>';
		out += '<th width="15%">Band</th>';
		out += '<th width="15%">Gain (dBi)</th>';
		out += '<th></th></tr>\n';
		a_bands = {};
		for (var b in this.bands) {
			var bf = band_to_frequency(b);
			a_bands[bf] = b;
		}
		for (var f in a_bands) {
			var band = a_bands[f];
			out += '<tr><td>'+band+'</td>';
			out += '<td>'+this.bands[band].gain+'</td>';
			out += '<td class="action-box">';
			out += '<a class="link edit-a" id="edit-a-aband-'+this.id+'-'+band+'">Edit</a> |';
			out += '<a class="link del-a" id="del-a-aband-'+this.id+'-'+band+'">Delete</a>';
			out += '</td></tr>\n';
		}
		if (array_size(this.bands) == 0) {
			var msg = 'This antenna does not yet have bands defined.  Please click on "Add a band".';
			out += '<tr><td colspan="3" class="error">'+msg+'</td></tr>';
		}
		out += '</table></div>';
		return out;
	};

	return this.init(name, ant_data);
}
Antenna.reset_form_errors = function() {
	$('#edit-antenna-name').removeClass('ui-state-error');
	$('#edit-antenna-cdx').removeClass('ui-state-error');
	$('#edit-antenna-udx').removeClass('ui-state-error');
};
Antenna.common_id = 0;

function antenna_by_name(name) {
	for (var a in antennas) {
		if (antennas[a].name == name)
			return antennas[a];
	}
	return null;
}

// conn_data is [transmitter, antenna, tuner_loss, wire, length, other_loss]
function Connection(conn_data) {
	this.init = function(conn_data) {
		if (conn_data == null) {
			this.transmitter = null;
			this.antenna = null;
			this.tuner_loss = this.length = this.other_loss = 0;
			this.wire = '';
			this.name = '';
		} else {
			this.transmitter = transmitter_by_name(conn_data[0]);
			this.antenna = antenna_by_name(conn_data[1]);
			this.tuner_loss = conn_data[2];
			this.wire = conn_data[3];
			this.length = conn_data[4];
			this.other_loss = conn_data[5];
			this.name = conn_data[0] + ' <-> ' + conn_data[1];
		}
		this.id = Connection.common_id++;
		return true;
	};

	this.fini = function() {
		return [this.transmitter.name, this.antenna.name,
				this.tuner_loss, this.wire, this.length, this.other_loss];
	};

	this.ask_delete = function() {
		return confirm('Delete '+this.name+' connection?');
	};

	this.save = function() {
		var xmtr = transmitters[parseInt($('#edit-conn-xmtr').val())];
		var ant = antennas[parseInt($('#edit-conn-ant').val())];
		var tloss = parseFloat($('#edit-conn-tloss').val());
		var wire = $('#edit-conn-wire').val();
		var wlen = parseFloat($('#edit-conn-wlen').val());
		var other = parseFloat($('#edit-conn-other').val());
		var name = xmtr.name + ' <-> ' + ant.name;
		var msg;
		if (!is_numeric(tloss)) {
			form_message($('#conn-editor-msg'),
				'Tuner losses must be numeric',
				$('#edit-conn-tloss')
			);
			return false;
		}
		if (!is_numeric(wlen) || wlen <= 0) {
			if (!is_numeric(wlen))
				msg = 'Wire length must be numeric';
			else
				msg = 'Wire length must be > 0';
			form_message($('#conn-editor-msg'),
				msg, $('#edit-conn-wlen')
			);
			return false;
		}
		if (!is_numeric(other)) {
			form_message($('#conn-editor-msg'),
				'Other losses must be numeric',
				$('#edit-conn-other')
			);
			return false;
		}
		// console.log('saving "'+name+'": tloss: '+tloss+', wire: '+wire+', length: '+wlen+', other: '+other);
		this.transmitter = xmtr;
		this.antenna = ant;
		this.tuner_loss = tloss;
		this.wire = wire;
		this.length = wlen;
		this.other_loss = other;
		connections[this.id] = this;
		save_connections();
		refresh();
		return true;
	};

	this.editor = function(next) {
		// set the title
		var title;
		if (this.transmitter == null) {
			title = 'Add an connection';
		} else {
			title = 'Edit connection';
		}
		// set up the selects
		var tid = this.transmitter?this.transmitter.id:null;
		var aid = this.antenna?this.antenna.id:null;
		var wire_keys = new Array();
		for (wire in wires) {
			wire_keys[wire] = wires[wire].name;
		}
		$('#edit-conn-xmtr').empty().append(select_options(this.xmtr_list(), tid));
		$('#edit-conn-ant').empty().append(select_options(this.ant_list(), aid));
		$('#edit-conn-wire').empty().append(select_options(wire_keys, this.wire));
		// console.log('connction: xmtr='+this.transmitter.name+', ant='+this.antenna.name);
		// set the field values
		if (this.transmitter != null) {
			$('#edit-conn-xmtr').val(this.transmitter.id);
		}
		if (this.antenna != null) {
			$('#edit-conn-ant').val(this.antenna.id);
		}
		$('#edit-conn-tloss').val(this.tuner_loss);
		$('#edit-conn-wire').val(this.wire);
		$('#edit-conn-wlen').val(this.length);
		$('#edit-conn-other').val(this.other_loss);
		// set the buttons to reflect this object
		var thing = this;
		$('#conn-editor').dialog('option', {
			'buttons': {
				'Save':function() {
					Connection.reset_form_errors();
					if (thing.save()) {
						$(this).dialog('close');
						if (next != null) {
							add_a_thing(null, next);
						}
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
				},
			},
			'title': title,
		});
		$('#conn-editor').dialog('open');
	};

	this.render = function() {
		var out = '<div class="connection action-popup"><div class="action-box">';
		out += '<a class="link edit-a" id="edit-a-conn-'+this.id+'">Edit</a> |';
		out += '<a class="link del-a" id="del-a-conn-'+this.id+'">Delete</a>';
		out += '</div>';
		out += '<h4>\''+this.transmitter.name+'\' to \''+this.antenna.name+'\' via '+ this.length+' ft of \''+this.wire+'\'</h4>\n';
		out += '<ul>';
		out += '<li>Transmitter: '+this.transmitter.name+'</li>\n';
		out += '<li>Antenna: '+this.antenna.name+'</li>\n';
		out += '<li>Tuner losses: '+this.tuner_loss+'</li>\n';
		out += '<li>Wire type: '+this.wire+'</li>\n';
		out += '<li>Wire length: '+this.length+'</li>\n';
		out += '<li>Other losses: '+this.other_loss+'</li>\n';
		out += '</ul></div>';
		return out;
	};

	this.results = function() {
		var tm = this.transmitter;
		var ant = this.antenna;
		ret = '<h3>\''+tm.name+'\' to \''+ant.name+'\' via '+ this.length+' ft of \''+this.wire+'\'</h3><div>Controlled distance: '+ant.cdx+' ft., Uncontrolled distance: '+ant.udx+' ft</div>';
		ret += '<table class="results"><tr>';
		ret += '<th rowspan="2">Band</th>';
		ret += '<th rowspan="2" title="Power = power from transmitter for this band">Power (W)</th>';
		ret += '<th rowspan="2" title="Line Losses = loss/ft * line length">Line Losses (dB)</th>';
		ret += '<th rowspan="2" title="Total Gain = antenna gain - (tuner loss + line loss + other loss)">Total Gain (dB)</th>';
		ret += '<th rowspan="2" title="EIRP = total gain * power">EIRP (W)</th>';
		ret += '<th class="left-border" colspan="5">Controlled Exposure (6 minute window)</th>';
		ret += '<th class="left-border" colspan="5">Uncontrolled Exposure (30 minute window)</th>';
		ret += '</tr>\n<tr>';
		ret += '<th class="left-border" title="Time Ave Power = EIRP * modulation duty factor * controlled exposure factor">Time Ave Power (W)</th>';
		ret += '<th title="Maximum Permissible Exposure as specified by the FCC">MPE (mW/cm<sup>2</sup>)</th>';
		ret += '<th title="RF Exposure as calculated for this scenario">RF Exposure (mW/cm<sup>2</sup>)</th>';
		ret += '<th title="Minimum distance to antenna to be within compliance">Minimum Distance (ft)</th>';
		ret += '<th>Distance OK</th>';
		ret += '<th class="left-border" title="Time Ave Power = EIRP * modulation duty factor * uncontrolled exposure factor">Time Ave Power (W)</th>';
		ret += '<th title="Maximum Permissible Exposure as specified by the FCC">MPE (mW/cm<sup>2</sup>)</th>';
		ret += '<th title="RF Exposure as calculated for this scenario">RF Exposure (mW/cm<sup>2</sup>)</th>';
		ret += '<th title="Minimum distance to antenna to be within compliance">Minimum Distance (ft)</th>';
		ret += '<th>Distance OK</th>';
		ret += '</tr>\n';
		var bands_rendered = 0;
		var tm_bands = {};
		for (var b in tm.bands) {
			var bf = band_to_frequency(b);
			tm_bands[bf] = b;
		}
		for (var f in tm_bands) {
			var b = tm_bands[f];
			if (!(b in ant.bands)) continue;
			bands_rendered++;
			var band = tm.bands[b];
			var freq = band_to_frequency(b);
			var freqmhz = freq / 1000000.0;
			var mldb = (wires[this.wire].k1 * Math.sqrt(freqmhz) + wires[this.wire].k2 * freqmhz);
			// console.log('band: '+b+', wire: '+this.wire+', freq: '+freqmhz+' MHz, mldb: '+mldb);
			var line_loss = (this.length/100.0)*mldb;
			var tloss = this.tuner_loss + this.other_loss + line_loss;
			var tlossdb = -tloss + ant.bands[b].gain;
			tloss = Math.pow(10, -(tloss/10.0));
			var gain = Math.pow(10, ant.bands[b].gain/10.0);
			ret += '<tr class="res-row">';
			// calculate rfe/mpe/mdx for transmitter power at band with connection losses
			ce = calc_exposure(true, band.power, modulation_duty_factor[band.mod]/100.0, band.ce/100.0, tloss, gain, freq, ant.cdx*cm_per_foot, ant.ground);
			ue = calc_exposure(false, band.power, modulation_duty_factor[band.mod]/100.0, band.ue/100.0, tloss, gain, freq, ant.udx*cm_per_foot, ant.ground);
			ret += '<td class="nowrap">'+b+'</td><td>'+band.power+'</td>';
			ret += '<td>'+line_loss.toPrecision(4)+'</td>';
			ret += '<td>'+tlossdb.toPrecision(4)+'</td>';
			ret += '<td>'+(band.power*tloss*gain).toPrecision(4)+'</td>';
			// controlled exposure
			ret += '<td class="left-border">'+ce.avgp.toPrecision(4)+'</td>';
			ret += '<td>'+ce.mpe.toPrecision(4)+'</td>';
			ret += '<td>'+ce.rfe.toPrecision(4)+'</td>';
			ret += '<td>'+(ce.mdx/cm_per_foot).toPrecision(4)+'</td>';
			ret += '<td class="'+(ce.rfe < ce.mpe ? '':'non')+'compliant">'+(ce.rfe < ce.mpe ? 'Yes':'No')+'</td>';
			// uncontrolled exposure
			ret += '<td class="left-border">'+ue.avgp.toPrecision(4)+'</td>';
			ret += '<td>'+ue.mpe.toPrecision(4)+'</td>';
			ret += '<td>'+ue.rfe.toPrecision(4)+'</td>';
			ret += '<td>'+(ue.mdx/cm_per_foot).toPrecision(4)+'</td>';
			ret += '<td class="'+(ue.rfe < ue.mpe ? '':'non')+'compliant">'+(ue.rfe < ue.mpe ? 'Yes':'No')+'</td>';
			ret += '</tr>';
		}
		if (bands_rendered == 0) {
			if (array_size(tm.bands) == 0) {
				msg = 'Transmitter "'+tm.name+'" has no bands. Please go to the Transmitters tab and add bands there first.';
			} else if (array_size(ant.bands) == 0) {
				msg = 'Antenna "'+ant.name+'" has no bands. Please go to the Antennas tab and add bands there first.';
			} else {
				msg = 'There are no bands on transmitter "'+tm.name+'" that match the bands on antenna "'+ant.name+'".  Make sure that the bands are correct for your transmitter and antenna.';
			}
			ret += '<tr><td colspan="15" class="error">'+msg+'</td></tr>';
		}
		ret += '</table>';
		return ret;
	};

	this.xmtr_list = function() {
		var ret = {};
		for (var t in transmitters) {
			ret[transmitters[t].id] = transmitters[t].name;
		}
		return ret;
	};

	this.ant_list = function() {
		var ret = {};
		for (var a in antennas) {
			ret[antennas[a].id] = antennas[a].name;
		}
		return ret;
	};

	return this.init(conn_data);
}
Connection.reset_form_errors = function() {
	$('#edit-conn-tloss').removeClass('ui-state-error');
	$('#edit-conn-wlen').removeClass('ui-state-error');
	$('#edit-conn-other').removeClass('ui-state-error');
};
Connection.common_id = 0;

function form_message(f, m, w) {
	if (!m) {
		f.text('');
		f.hide();
		return;
	}
	w.addClass('ui-state-error');
	f.text(m).addClass('ui-state-error');
	f.show();
	setTimeout(function() {
			f.removeClass('ui-state-error');
		}, 3000);
}

function connection_idx_from_transmitter(name) {
	conns = [];
	for (var c in connections) {
		var t = connections[c].transmitter;
		//console.log('compare "'+name+'" to "'+t.name+'"');
		if (t.name == name) {
			console.log('found connection: '+connections[c].name);
			conns.push(c);
		}
	}
	return conns;
}

function connection_idx_from_antenna(name) {
	conns = [];
	for (var c in connections) {
		var a = connections[c].antenna;
		//console.log('compare "'+name+'" to "'+a.name+'"');
		if (a.name == name) {
			// console.log('found connection: '+connections[c].name);
			conns.push(c);
		}
	}
	return conns;
}

function add_a_thing(ele, next) {
	var type;
	var id;
	var thing;
	if (next == null) {
		var m = $(ele).prop('id').split('-');
		type = m[2];
		id = parseInt(m[3]);
		thing = null;
	} else {
		// console.log('add a thing next: '+next);
		type = next[0];
		id = next[1];
	}
	switch (type) {
		case "xmtr":
			thing = new Transmitter();
			next = [ 'tband', thing.id ];
			break;
		case "tband":
			thing = new TransmitterBand(transmitters[id]);
			break;
		case "antenna":
			thing = new Antenna();
			next = [ 'aband', thing.id ];
			break;
		case "aband":
			thing = new AntennaBand(antennas[id]);
			break;
		case "connection":
			thing = new Connection();
			break;
	}
	if (thing == null) return;
	thing.editor(next);
}

function edit_a_thing(ele) {
	var m = $(ele).prop('id').split('-');
	var type = m[2];
	var id = parseInt(m[3]);
	var index = m[4];
	var thing = null;
	// console.log('edit_a_thing: type = '+type+', id = '+id+', index = '+index);
	switch (type) {
		case "xmtr":
			thing = transmitters[id];
			break;
		case "tband":
			thing = transmitters[id].bands[index];
			break;
		case "antenna":
			thing = antennas[id];
			break;
		case "aband":
			thing = antennas[id].bands[index];
			break;
		case "conn":
			thing = connections[id];
			break;
	}
	if (thing == null) return;
	thing.editor();
}

function del_a_thing(ele) {
	var m = $(ele).prop('id').split('-');
	var type = m[2];
	var id = parseInt(m[3]);
	var index = m[4];
	var thing = null;
	// console.log('del_a_thing: type = '+type+', id = '+id+', index = '+index);
	switch (type) {
		case "xmtr":
			if (transmitters[id].ask_delete()) {
				var name = transmitters[id].name;
				var conns = connection_idx_from_transmitter(name);
				for (var c in conns) {
					// console.log('deleting conn '+connections[conns[c]].name);
					delete connections[conns[c]];
				}
				delete transmitters[id];
				save_transmitters();
				save_connections();
			} else return;
			break;
		case "tband":
			if (transmitters[id].bands[index].ask_delete()) {
				delete transmitters[id].bands[index];
				save_transmitters();
			} else return;
			break;
		case "antenna":
			if (antennas[id].ask_delete()) {
				var name = antennas[id].name;
				var conns = connection_idx_from_antenna(name);
				for (var c in conns) {
					// console.log('deleting conn '+connections[conns[c]].name);
					delete connections[conns[c]];
				}
				delete antennas[id];
				save_antennas();
				save_connections();
			} else return;
			break;
		case "aband":
			if (antennas[id].bands[index].ask_delete()) {
				delete antennas[id].bands[index];
				save_antennas();
			} else return;
			break;
		case "conn":
			if (connections[id].ask_delete()) {
				for (var c in connections) {
					if (connections[c].id == id) {
						// console.log('deleting conn '+connections[c].name);
						delete connections[c];
					}
				}
			} else return;
			break;
	}
	refresh();
}

var wires = {
	'10D-FB': { 'name': '10D-FB', 'k1': 0.088544, 'k2': 0.000815, },
	'12D-FB': { 'name': '12D-FB', 'k1': 0.077633, 'k2': 0.000511, },
	'5D-FB': { 'name': '5D-FB', 'k1': 0.177820, 'k2': 0.001007, },
	'7D-FB': { 'name': '7D-FB', 'k1': 0.115641, 'k2': 0.001003, },
	'8D-FB': { 'name': '8D-FB', 'k1': 0.117744, 'k2': 0.000851, },
	'AL5-50': { 'name': 'Andrew AL5-50', 'k1': 0.036515, 'k2': 0.000110, },
	'AL7-50': { 'name': 'Andrew AL7-50', 'k1': 0.019065, 'k2': 0.000139, },
	'C2FCP': { 'name': 'Andrew C2FCP', 'k1': 0.124115, 'k2': 0.000423, },
	'C2FP': { 'name': 'Andrew C2FP', 'k1': 0.124084, 'k2': 0.000440, },
	'CNT-100': { 'name': 'Andrew CNT-100', 'k1': 0.698602, 'k2': 0.001793, },
	'CNT-195': { 'name': 'Andrew CNT-195', 'k1': 0.338633, 'k2': 0.000272, },
	'CNT-200': { 'name': 'Andrew CNT-200', 'k1': 0.319735, 'k2': 0.000284, },
	'CNT-240': { 'name': 'Andrew CNT-240', 'k1': 0.239390, 'k2': 0.000344, },
	'CNT-300': { 'name': 'Andrew CNT-300', 'k1': 0.192298, 'k2': 0.000257, },
	'CNT-400': { 'name': 'Andrew CNT-400', 'k1': 0.121920, 'k2': 0.000230, },
	'CNT-500': { 'name': 'Andrew CNT-500', 'k1': 0.097536, 'k2': 0.000221, },
	'CNT-600': { 'name': 'Andrew CNT-600', 'k1': 0.076078, 'k2': 0.000245, },
	'FSJ1-50': { 'name': 'Andrew FSJ1-50', 'k1': 0.172242, 'k2': 0.000453, },
	'FSJ2-50': { 'name': 'Andrew FSJ2-50', 'k1': 0.116098, 'k2': 0.000388, },
	'FSJ4-50': { 'name': 'Andrew FSJ4-50', 'k1': 0.099090, 'k2': 0.000470, },
	'HL4RP-50A': { 'name': 'Andrew HL4RP-50A', 'k1': 0.064709, 'k2': 0.000210, },
	'LDF1-50': { 'name': 'Andrew LDF1-50', 'k1': 0.119695, 'k2': 0.000372, },
	'LDF2-50': { 'name': 'Andrew LDF2-50', 'k1': 0.101102, 'k2': 0.000327, },
	'LDF4-50A': { 'name': 'Andrew LDF4-50A', 'k1': 0.064343, 'k2': 0.000187, },
	'LDF5-50A': { 'name': 'Andrew LDF5-50A', 'k1': 0.034839, 'k2': 0.000153, },
	'LDF6-50': { 'name': 'Andrew LDF6-50', 'k1': 0.023942, 'k2': 0.000140, },
	'LDF7-50': { 'name': 'Andrew LDF7-50', 'k1': 0.019050, 'k2': 0.000139, },
	'VXL5-50': { 'name': 'Andrew VXL5-50', 'k1': 0.038222, 'k2': 0.000153, },
	'VXL7-50': { 'name': 'Andrew VXL7-50', 'k1': 0.019065, 'k2': 0.000139, },
	'ARRL300': { 'name': 'ARRL Generic 300', 'k1': 0.101803, 'k2': 0.000682, },
	'ARRL450': { 'name': 'ARRL Generic 450 Ladder', 'k1': 0.027130, 'k2': 0.000242, },
	'AF8': { 'name': 'Australian Twin flex 24/0.20 (0.5sqmm)', 'k1': 0.914400, 'k2': 0.030480, },
	'B1189A': { 'name': 'Belden 1189A (RG6/U)', 'k1': 0.189860, 'k2': 0.000413, },
	'B1530A': { 'name': 'Belden 1530A (RG6/U)', 'k1': 0.192085, 'k2': 0.000418, },
	'B1694A': { 'name': 'Belden 1694A (RG-6/U)', 'k1': 0.187208, 'k2': 0.000512, },
	'B7806R': { 'name': 'Belden 7806R', 'k1': 0.297119, 'k2': 0.001468, },
	'B8210': { 'name': 'Belden 8210 (13AWG twin)', 'k1': 0.325526, 'k2': 0.007102, },
	'B8216': { 'name': 'Belden 8216 (RG-174/U)', 'k1': 0.755599, 'k2': 0.009696, },
	'B8222': { 'name': 'Belden 8222 (20AWG twin)', 'k1': 0.741578, 'k2': 0.002617, },
	'B8237': { 'name': 'Belden 8237 (RG8/U)', 'k1': 0.170871, 'k2': 0.001964, },
	'B8259': { 'name': 'Belden 8259 (RG58A/U)', 'k1': 0.453238, 'k2': 0.008364, },
	'B8262': { 'name': 'Belden 8262 (RG-58C/U)', 'k1': 0.397459, 'k2': 0.009004, },
	'B8267': { 'name': 'Belden 8267 (RG-213/U)', 'k1': 0.164104, 'k2': 0.002790, },
	'B8268': { 'name': 'Belden 8268 (RG-214/U)', 'k1': 0.179100, 'k2': 0.002186, },
	'B83241': { 'name': 'Belden 83241 (RG-141/U)', 'k1': 0.373685, 'k2': 0.001585, },
	'B84303': { 'name': 'Belden 84303 (RG303/U)', 'k1': 0.373685, 'k2': 0.001593, },
	'B84316': { 'name': 'Belden 84316 (RG316)', 'k1': 0.790956, 'k2': 0.003990, },
	'B9011': { 'name': 'Belden 9011', 'k1': 0.115641, 'k2': 0.000497, },
	'B9204': { 'name': 'Belden 9204 (RG-59/U)', 'k1': 0.319126, 'k2': 0.001792, },
	'B9212': { 'name': 'Belden 9212 (RG-11/U)', 'k1': 0.181752, 'k2': 0.001497, },
	'B9258': { 'name': 'Belden 9258 (RG-8/X)', 'k1': 0.285110, 'k2': 0.002264, },
	'B9269': { 'name': 'Belden 9269 (RG-62/U)', 'k1': 0.263500, 'k2': 0.000358, },
	'B9275': { 'name': 'Belden 9275', 'k1': 0.222077, 'k2': 0.000573, },
	'B9913': { 'name': 'Belden 9913', 'k1': 0.112685, 'k2': 0.000963, },
	'B9914': { 'name': 'Belden 9914', 'k1': 0.121585, 'k2': 0.000547, },
	'C1188': { 'name': 'Carol C.1188', 'k1': 0.444703, 'k2': 0.000406, },
	'P3-500-CA': { 'name': 'Commscope P3-500 CA', 'k1': 0.070866, 'k2': 0.000289, },
	'P3-750-JCA': { 'name': 'Commscope P3-750 JCA', 'k1': 0.047610, 'k2': 0.000237, },
	'DBF': { 'name': 'Davis BURY-FLEX', 'k1': 0.118506, 'k2': 0.001408, },
	'D-RG6': { 'name': 'Digimatch RG6', 'k1': 0.210312, 'k2': 0.000000, },
	'ECO10': { 'name': 'Ecoflex 10', 'k1': 0.117927, 'k2': 0.000590, },
	'ECO15': { 'name': 'Ecoflex 15', 'k1': 0.081473, 'k2': 0.000412, },
	'RG-8X': { 'name': 'Generic RG-8X', 'k1': 0.26904, 'k2': 0.00572, },
	'LL-195': { 'name': 'Jefatech Low Loss 195', 'k1': 0.424282, 'k2': 0.000563, },
	'LL-400': { 'name': 'Jefatech Low Loss 400', 'k1': 0.122286, 'k2': 0.000260, },
	'LL-400F': { 'name': 'Jefatech Low Loss 400 Flex', 'k1': 0.146761, 'k2': 0.000312, },
	'LL-600': { 'name': 'Jefatech Low Loss 600', 'k1': 0.075560, 'k2': 0.000260, },
	'5D2V': { 'name': 'JIS 5D2V', 'k1': 0.249022, 'k2': 0.001442, },
	'8D2V': { 'name': 'JIS 8D2V', 'k1': 0.188397, 'k2': 0.001157, },
	'LCF38-50': { 'name': 'LCF38-50', 'k1': 0.102291, 'k2': 0.000219, },
	'O600': { 'name': 'Open / air dielectric (150/2.00)', 'k1': 0.018471, 'k2': 0.000000, },
	'O400': { 'name': 'Open / air dielectric ( 19/1.30)', 'k1': 0.042672, 'k2': 0.000000, },
	'O470': { 'name': 'Open / air dielectric ( 25.4/1.02)', 'k1': 0.046939, 'k2': 0.000000, },
	'O360': { 'name': 'Open / air dielectric (  7.5/0.72)', 'k1': 0.086868, 'k2': 0.000000, },
	'O450': { 'name': 'Open / TE-450SP (50/2.0)', 'k1': 0.024841, 'k2': 0.000000, },
	'R9001': { 'name': 'RFI Cellfoam', 'k1': 0.462382, 'k2': 0.000000, },
	'R9006': { 'name': 'RFI Cellfoil', 'k1': 0.346558, 'k2': 0.000000, },
	'RG-11/U': { 'name': 'RG-11/U', 'k1': 0.185898, 'k2': 0.001227, },
	'RG-122/U': { 'name': 'RG-122/U', 'k1': 0.612953, 'k2': 0.007160, },
	'RG-141A/U': { 'name': 'RG-141A/U', 'k1': 0.260238, 'k2': 0.004730, },
	'RG-142B/U': { 'name': 'RG-142B/U', 'k1': 0.374294, 'k2': 0.001680, },
	'RG-174/U': { 'name': 'RG-174/U', 'k1': 0.792175, 'k2': 0.004843, },
	'RG-178B/U': { 'name': 'RG-178B/U', 'k1': 1.338682, 'k2': 0.003533, },
	'RG-179B/U': { 'name': 'RG-179B/U', 'k1': 0.990905, 'k2': 0.000000, },
	'RG-180B/U': { 'name': 'RG-180B/U', 'k1': 0.549554, 'k2': 0.000000, },
	'RG-187A/U': { 'name': 'RG-187A/U', 'k1': 0.990905, 'k2': 0.000000, },
	'RG-188A/U': { 'name': 'RG-188A/U', 'k1': 0.953414, 'k2': 0.000192, },
	'RG-196A/U': { 'name': 'RG-196A/U', 'k1': 1.338682, 'k2': 0.003533, },
	'RG-213/U': { 'name': 'RG-213/U', 'k1': 0.181844, 'k2': 0.003094, },
	'RG-214/U': { 'name': 'RG-214/U', 'k1': 0.181844, 'k2': 0.003094, },
	'RG-218/U': { 'name': 'RG-218/U', 'k1': 0.085893, 'k2': 0.001607, },
	'RG-223/U': { 'name': 'RG-223/U', 'k1': 0.399593, 'k2': 0.003603, },
	'RG-303/U': { 'name': 'RG-303/U', 'k1': 0.260238, 'k2': 0.004730, },
	'RG-316/U': { 'name': 'RG-316/U', 'k1': 0.848563, 'k2': 0.003639, },
	'RG-400': { 'name': 'RG-400', 'k1': 0.329489, 'k2': 0.002790, },
	'RG-402': { 'name': 'RG-402', 'k1': 0.401422, 'k2': 0.000737, },
	'RG-405': { 'name': 'RG-405', 'k1': 0.669950, 'k2': 0.000928, },
	'RG-58A/U': { 'name': 'RG-58A/U', 'k1': 0.394411, 'k2': 0.009010, },
	'RG-58C/U': { 'name': 'RG-58C/U', 'k1': 0.394411, 'k2': 0.009010, },
	'RG-58/U': { 'name': 'RG-58/U', 'k1': 0.424282, 'k2': 0.003615, },
	'RG-59B/U': { 'name': 'RG-59B/U', 'k1': 0.317906, 'k2': 0.001923, },
	'RG-59/U': { 'name': 'RG-59/U', 'k1': 0.320954, 'k2': 0.001844, },
	'RG-62B/U': { 'name': 'RG-62B/U', 'k1': 0.253441, 'k2': 0.002945, },
	'RG-62/U': { 'name': 'RG-62/U', 'k1': 0.265359, 'k2': 0.000287, },
	'RG-6A/U': { 'name': 'RG-6A/U', 'k1': 0.141976, 'k2': 0.003380, },
	'RG-8/U': { 'name': 'RG-8/U', 'k1': 0.181844, 'k2': 0.003094, },
	'RG-9/U': { 'name': 'RG-9/U', 'k1': 0.181844, 'k2': 0.003094, },
	'SM141-35': { 'name': 'SUCOFORM_141_35', 'k1': 0.492557, 'k2': 0.000273, },
	'SM141': { 'name': 'SUCOFORM_141', 'k1': 0.342290, 'k2': 0.001219, },
	'LMR-1200': { 'name': 'Times Microwave LMR-1200', 'k1': 0.037368, 'k2': 0.000160, },
	'LMR-1700': { 'name': 'Times Microwave LMR-1700', 'k1': 0.026460, 'k2': 0.000160, },
	'LMR-195': { 'name': 'Times Microwave LMR-195', 'k1': 0.356921, 'k2': 0.000470, },
	'LMR-195-UF': { 'name': 'Times Microwave LMR-195-UF', 'k1': 0.424282, 'k2': 0.000563, },
	'LMR-200': { 'name': 'Times Microwave LMR-200', 'k1': 0.320954, 'k2': 0.000330, },
	'LMR-200-UF': { 'name': 'Times Microwave LMR-200-UF', 'k1': 0.384962, 'k2': 0.000396, },
	'LMR-240': { 'name': 'Times Microwave LMR-240', 'k1': 0.242072, 'k2': 0.000330, },
	'LMR-240-UF': { 'name': 'Times Microwave LMR-240-UF', 'k1': 0.290505, 'k2': 0.000396, },
	'LMR-300': { 'name': 'Times Microwave LMR-300', 'k1': 0.191933, 'k2': 0.000330, },
	'LMR-400-75': { 'name': 'Times Microwave LMR-400-75', 'k1': 0.115580, 'k2': 0.000260, },
	'LMR-400': { 'name': 'Times Microwave LMR-400', 'k1': 0.122286, 'k2': 0.000260, },
	'LMR-400-UF': { 'name': 'Times Microwave LMR-400-UF', 'k1': 0.146761, 'k2': 0.000312, },
	'LMR-500': { 'name': 'Times Microwave LMR-500', 'k1': 0.096591, 'k2': 0.000260, },
	'LMR-500-UF': { 'name': 'Times Microwave LMR-500-UF', 'k1': 0.115915, 'k2': 0.000312, },
	'LMR-600': { 'name': 'Times Microwave LMR-600', 'k1': 0.075560, 'k2': 0.000260, },
	'LMR-600-UF': { 'name': 'Times Microwave LMR-600-UF', 'k1': 0.090648, 'k2': 0.000312, },
	'LMR-900': { 'name': 'Times Microwave LMR-900', 'k1': 0.051755, 'k2': 0.000160, },
	'UR57': { 'name': 'UR57', 'k1': 0.170962, 'k2': 0.001726, },
	'UR67': { 'name': 'UR67', 'k1': 0.184160, 'k2': 0.001682, },
	'UT-141-25': { 'name': 'UT-141C-25', 'k1': 0.437388, 'k2': 0.000810, },
	'UT-141-35': { 'name': 'UT-141C-35', 'k1': 0.368198, 'k2': 0.000827, },
	'UT-141-50': { 'name': 'UT-141-HA-M17', 'k1': 0.332537, 'k2': 0.001158, },
	'WF103': { 'name': 'WestFlex 103', 'k1': 0.108174, 'k2': 0.000632, },
	'W551': { 'name': 'Wireman 551', 'k1': 0.049591, 'k2': 0.001200, },
	'W551w': { 'name': 'Wireman 551 wet', 'k1': 0.056540, 'k2': 0.071750, },
	'W552': { 'name': 'Wireman 552', 'k1': 0.050993, 'k2': 0.001000, },
	'W552w': { 'name': 'Wireman 552 wet', 'k1': 0.055565, 'k2': 0.061813, },
	'W553': { 'name': 'Wireman 553', 'k1': 0.062088, 'k2': 0.000900, },
	'W553w': { 'name': 'Wireman 553 wet', 'k1': 0.072908, 'k2': 0.055108, },
	'W554': { 'name': 'Wireman 554', 'k1': 0.041392, 'k2': 0.001700, },
	'W554w': { 'name': 'Wireman 554 wet', 'k1': 0.030815, 'k2': 0.077572, },
	'ZIP105': { 'name': 'ZIP 105 (2.74/1.22)', 'k1': 0.711098, 'k2': 0.127498, },
};
var ham_bands = {
	'160m':[1800000,2000000],
	'80m':[3500000,4000000],
	'60m':[5330000,5405000],
	'40m':[7000000,7300000],
	'30m':[10100000,10150000],
	'20m':[14000000,14350000],
	'17m':[18068000,18168000],
	'15m':[21000000,21450000],
	'12m':[24890000,24990000],
	'10m':[28000000,29700000],
	'6m':[50000000,54000000],
	'2m':[144000000,148000000],
	'220 MHz':[222000000,225000000],
	'440 MHz':[420000000,450000000],
	'900 MHz':[902000000,928000000],
	'1.2 GHz':[1240000000,1300000000],
	'2.3 GHz':[2300000000,2310000000],
	'2.4 GHz':[2390000000,2450000000],
	'3.3 GHz':[3300000000,3500000000],
	'5.6 GHz':[5650000000,5925000000],
	'10 GHz':[10000000000,10500000000],
	'24 GHz':[24000000000,24250000000],
	'47 GHz':[47000000000,47200000000],
	'76 GHz':[76000000000,81000000000],
	'122 GHz':[122250000000,123000000000],
	'134 GHz':[134000000000,141000000000],
	'241 GHz':[241000000000,250000000000],
	'275 GHz':[275000000000,300000000000],
};
function bands_filter(bands, current_band) {
	var ret = {};
	for (band in Bands) {
		if (band == current_band || !(band in bands)) {
			var b = Bands[band];
			ret[band] = b.slice(0, b.length);
		}
	}
	return ret;
}

var modulation_duty_factor = {
	'CW': 44,
	'SSB: no processing': 25,
	'SSB: medium processing': 40,
	'SSB: heavy processing': 50,
	'SSB AFSK': 100,
	'SSB SSTV': 100,
	'FSK': 100,
	'FM': 100,
	'RTTY': 95,
	'PSK31': 75,
	'JT65': 100,
	'AM: 50% modulation': 50,
	'AM: 100% modulation': 25,
	'AM: carrier': 100,
	'ATV': 60,
};

var transmitters = {};
var antennas = {};
var connections = [];
var Bands = {};

function save_transmitters() {
	var xmtr_data = {}
	for (var k in transmitters) {
		var v = transmitters[k].fini();
		xmtr_data[v[0]] = v[1];
	}
	setvar('transmitters', xmtr_data);
	save_bands();
}
function load_transmitters(xmtr_data) {
	xmtr_data = xmtr_data || getvar('transmitters', {});
	var t = {}
	for (var k in xmtr_data) {
		var nt = new Transmitter([k, xmtr_data[k]]);
		t[nt.id] = nt;
	}
	return t;
}
function save_antennas() {
	var ant_data = {}
	for (var k in antennas) {
		var v = antennas[k].fini();
		ant_data[v[0]] = v[1];
	}
	setvar('antennas', ant_data);
	save_bands();
}
function load_antennas(ant_data) {
	ant_data = ant_data || getvar('antennas', {});
	var a = {};
	for (var k in ant_data) {
		var na = new Antenna(k, ant_data[k]);
		a[na.id] = na;
	}
	return a;
}
function save_connections() {
	var conn_data = new Array();
	for (var k in connections) {
		conn_data.push(connections[k].fini());
	}
	setvar('connections', conn_data);
}
function load_connections(conn_data) {
	conn_data = conn_data || getvar('connections', []);
	var c = [];
	for (var k in conn_data) {
		c[k] = new Connection(conn_data[k]);
	}
	return c;
}
function save_bands() {
	var band_data = {};
	for (var t in transmitters) {
		for (var tb in transmitters[t].bands) {
			if (!(tb in ham_bands))
			{
				f = band_to_frequency(tb);
				band_data[tb] = [f, f];
			}
		}
	}
	for (var a in antennas) {
		for (var ab in antennas[a].bands) {
			if (!(ab in ham_bands) && !(ab in band_data))
			{
				f = band_to_frequency(ab);
				band_data[ab] = [f, f];
			}
		}
	}
	// console.log(band_data);
	Bands = load_bands(band_data);
	setvar('bands', band_data);
}
function load_bands(band_data) {
	band_data = band_data || getvar('bands', {});
	bands = {};
	for (var b in ham_bands) {
		var v = ham_bands[b];
		bands[b] = v.slice(0, v.length);
	}
	for (var b in band_data) {
		var v = band_data[b];
		bands[b] = v.slice(0, v.length);
	}
	return bands;
}
function load_all_data()
{
	transmitters = load_transmitters();
	antennas = load_antennas();
	connections = load_connections();
	Bands = load_bands();
}

function page_init() {
	$('#tabs > ul').show()
	$('#eximport-import').unbind('click').click(import_data);
	$('#eximport-export').unbind('click').click(export_data);
	$('#eximport-reset').unbind('click').click(reset_data);
	$('#eximport-sample').unbind('click').click(reset_data_sample);
	$('.hideme').hide();
	// set up the modal dialogs
	$('#tband-editor').dialog({
		autoOpen: false,
		width: '24em',
		modal: true,
		close: function() {
			TransmitterBand.reset_form_errors();
			form_message($('#tband-editor-msg'));
		}
	});
	$('#xmtr-editor').dialog({
		autoOpen: false,
		width: '24em',
		modal: true,
		close: function() {
			Transmitter.reset_form_errors();
			form_message($('#xmtr-editor-msg'));
		}
	});
	$('#aband-editor').dialog({
		autoOpen: false,
		width: '24em',
		modal: true,
		close: function() {
			AntennaBand.reset_form_errors();
			form_message($('#aband-editor-msg'));
		}
	});
	$('#antenna-editor').dialog({
		autoOpen: false,
		width: '24em',
		modal: true,
		close: function() {
			Antenna.reset_form_errors();
			form_message($('#antenna-editor-msg'));
		}
	});
	$('#conn-editor').dialog({
		autoOpen: false,
		width: '24em',
		modal: true,
		close: function() {
			Connection.reset_form_errors();
			form_message($('#conn-editor-msg'));
		}
	});
	$('#editor-forms').remove();
}

function do_interactive() {
	$('.action-popup').hover(function() {
		$(this).find('.action-box').show();
	}, function() {
		$(this).find('.action-box').hide();
	});
	$('.link').filter('.help').unbind('click').click(function() {
		var m = $(this).prop('id').split('-');
		var type = m[1];
		$('#help-'+type).hide();
		$('#help-text-'+type).slideDown(250);
	});
	$('.link').filter('.help-hide').unbind('click').click(function() {
		var m = $(this).prop('id').split('-');
		var type = m[2];
		$('#help-text-'+type).slideUp(250, function() {
			$('#help-'+type).show();
		});
	});
}
function post_render() {
	$(".link").filter(".add-a").unbind('click').click(function() {
			add_a_thing(this);
	});
	$(".link").filter(".del-a").unbind('click').click(function() {
			del_a_thing(this);
	});
	$(".link").filter(".edit-a").unbind('click').click(function() {
			edit_a_thing(this);
	});
	$(".link").filter("#reset-data").unbind('click').click(function() {
		console.log('resetting data');
		reset_data_store();
	});
	var prot = ["&#109;", "&#97;", "&#105;", "&#108;", "&#116;", "&#111;", "&#58;"].join('');
	var addr = ["&#110;", "&#55;", "&#111;", "&#104;", "&#64;", "&#97;", "&#114;", "&#114;", "&#108;", "&#46;", "&#110;", "&#101;", "&#116;"];
	addr = addr.join('');
	$("#contact").replaceWith('<a href="'+prot+addr+'">'+addr+'</a>');
}

function refresh(mask_errors) {
	if (mask_errors == null) mask_errors = true;
	var error = null;
	try {
		show_transmitters();
	} catch (e) { log_err('transmitters failed to render: ', e); error = e; }; try {
		show_antennas();
	} catch (e) { log_err('antennas failed to render: ', e); error = e; }; try {
		show_connections();
	} catch (e) { log_err('connections failed to render: ', e); error = e; }; try {
		show_results();
	} catch (e) { log_err('results failed to render: ', e); error = e; }
	if (error != null && !mask_errors) throw error;
	do_interactive();
	post_render();
}
function show_transmitters() {
	console.log('show_transmitters');
	$('#transmitters > .dynamic').children().remove();
	var rendered_something = false;
	for (var t in transmitters) {
		rendered_something = true;
		$('#transmitters > .dynamic').append(transmitters[t].render());
	}
	if (!rendered_something) {
		$('#help-xmtr').hide();
		$('#help-text-xmtr').show();
	}
}
function show_antennas() {
	console.log('show_antennas');
	$('#antennas > .dynamic').children().remove();
	var rendered_something = false;
	for (var a in antennas) {
		rendered_something = true;
		$('#antennas > .dynamic').append(antennas[a].render());
	}
	if (!rendered_something) {
		$('#help-antenna').hide();
		$('#help-text-antenna').show();
	}
}
function show_connections() {
	console.log('show_connections');
	$('#connections > .dynamic').children().remove();
	var rendered_something = false;
	for (var c in connections) {
		rendered_something = true;
		$('#connections > .dynamic').append(connections[c].render());
	}
	if (!rendered_something) {
		$('#help-connection').hide();
		$('#help-text-connection').show();
	}
}
function show_results() {
	console.log('show_results');
	$('#results > .dynamic').children().remove();
	var rendered_something = false;
	for (var c in connections) {
		rendered_something = true;
		$('#results > .dynamic').append(connections[c].results());
	}
	if (!rendered_something) {
		$('#help-results').hide();
		$('#help-text-results').show();
	}
// | transmitter | power | band | tuner losses | line losses | other losses | rfe | mpe | mdx | ok
}
function reset_data_sample() {
	if ((array_size(transmitters) ||
		array_size(antennas) ||
		array_size(connections)) &&
		!confirm('This cannot be undone.\nReplace all transmitter/antenna/connection data?')) {
			return;
	}
	var ltransmitters = {
		// Transmitter(name, bands)
		//band info is [power, duty cycle, win_c, win_u]
		'IC-7000':{'160m':[100, 'CW', 50, 50], '80m':[100, 'CW', 50, 50], '60m':[50, 'SSB: medium processing', 50, 50], '40m':[100, 'SSB: medium processing', 50, 50], '30m':[100, 'SSB: medium processing', 50, 50], '20m':[100, 'SSB: medium processing', 50, 50], '17m':[100, 'SSB: medium processing', 50, 50], '15m':[100, 'SSB: medium processing', 50, 50], '12m':[100, 'SSB: medium processing', 50, 50], '10m':[100, 'SSB: medium processing', 50, 30], '6m':[100, 'FM', 50, 50], '2m':[50, 'FM', 50, 50], '440 MHz':[30, 'FM', 50, 50]},
		'Elecraft K3/100':{'160m':[100, 'CW', 50, 50], '80m':[100, 'CW', 50, 50], '60m':[50, 'SSB: medium processing', 50, 50], '40m':[100, 'SSB: medium processing', 50, 50], '30m':[100, 'SSB: medium processing', 50, 50], '20m':[100, 'SSB: medium processing', 50, 50], '17m':[100, 'SSB: medium processing', 50, 50], '15m':[100, 'SSB: medium processing', 50, 50], '12m':[100, 'SSB: medium processing', 50, 50], '10m':[100, 'SSB: medium processing', 50, 30]},
		'IC-92AD':{'2m':[5, 'FM', 50, 50], '440 MHz':[5, 'FM', 50, 50]},
	};
	var lantennas = {
		// Antenna(name, bands, cdx, udx, ground)
		'Center-fed Zepp':[{'80m':1.9, '60m':2.0, '40m':2.5, '30m':3.1, '20m':3.1, '17m':3.1, '15m':3.1, '12m':3.2, '10m':3.2,}, 18, 16, true],
		'6/2/440 collinear':[{'6m':3.07, '2m':8.3, '440 MHz':11.7}, 6, 15, true],
		'2/440 collinear':[{'2m':3.76, '440 MHz':4.32}, 1, 50, true],
		'2/440 dipole':[{'2m':2.2, '440 MHz':3.02}, 1, 50, true],
	};
	var lconnections = [
		// Connection(transmitter, antenna, tuner_loss, wire, length, other_loss)
		['Elecraft K3/100', 'Center-fed Zepp', 0.1, 'LL-400', 150, 0.2],
		['IC-7000', 'Center-fed Zepp', 0.1, 'RG-8X', 150, 0.2],
		['IC-7000', '6/2/440 collinear', 0.0, 'LL-400', 150, 0.2],
		['IC-92AD', '6/2/440 collinear', 0.0, 'LL-400', 150, 0.2],
		['IC-92AD', '2/440 collinear', 0.0, 'LL-400', 30.0, 0.0],
		['IC-92AD', '2/440 dipole', 0.0, 'LL-400', 30.0, 0.0],
		];
	setvar('antennas', lantennas);
	setvar('transmitters', ltransmitters);
	setvar('connections', lconnections);
	setvar('bands', {});
	setvar('schema', SCHEMA);
	/*
	// this only makes sense if we are not reloading the window
	load_all_data();
	refresh();
	*/
	window.location.reload(true);
}

function reset_data() {
	if ((array_size(transmitters) ||
		array_size(antennas) ||
		array_size(connections)) &&
		!confirm('This cannot be undone.\nDelete all transmitter/antenna/connection data?')) {
			return;
	}
	delvar('antennas');
	delvar('connections');
	delvar('transmitters');
	delete transmitters;
	delete antennas;
	delete connections;
	setvar('schema', SCHEMA);
	window.location.reload(true);
}
function export_data() {
	var data = {
		'schema': getvar('schema', SCHEMA),
		'antennas': getvar('antennas', {}),
		'connections': getvar('connections', []),
		'transmitters': getvar('transmitters', {}),
	};
	$('#eximport-data').val(JSON.stringify(data));
}
function import_data() {
	if ((array_size(transmitters) ||
		array_size(antennas) ||
		array_size(connections)) &&
		!confirm('This cannot be undone.\nReplace all transmitter/antenna/connection data?')) {
			return;
	}
	var oldant = antennas,
		oldcon = connections,
		oldxmtr = transmitters,
		oldschema = getvar('schema', 0);
	try {
		var data = $('#eximport-data').val();
		if (data.length < 60) return;
		console.log('import:\n'+data);
		data = JSON.parse(data);
		setvar('antennas', data['antennas']);
		setvar('connections', data['connections']);
		setvar('transmitters', data['transmitters']);
		setvar('schema', data['schema'] || 0)
		check_schema();
		load_all_data();
		refresh(false);
	} catch (e) {
		log_err('failed to import: ', e);
		alert('Imported data was not in correct format');
		antennas = oldant;
		connections = oldcon;
		transmitters = oldxmtr;
		save_antennas();
		save_connections();
		save_transmitters();
		setvar('schema', oldschema);
	}
	window.location.reload(true);
}
function calc_mpe(frequency, controlled) {
	frequency /= 1000000;
	if (frequency < 1.34) {
		return 100.0;
	}  /**  Below 1.34 MHz  **/
	else if (frequency < 3.0) {
		if (controlled) return 100.0;
		return 180.0 / (Math.pow(frequency,2));
	}  /**  Below 3.0 MHz  **/
	else if (frequency < 30.0) {
		if (controlled) return 900.0 / Math.pow(frequency,2);
		return 180.0 / (Math.pow(frequency,2));
	}  /**  Below 30 MHz  **/
	else if (frequency < 300.0) {
		if (controlled) return 1.0;
		return 0.2;
	}  /**  Below 300 MHz  **/
	else if (frequency < 1500.0) {
		if (controlled) return frequency / 300.0
			return frequency / 1500.0;
	}  /**  Below 1500 MHz  **/
	else if (frequency < 100000.0) {
		if (controlled) return 5.0;
		return 1.0;
	}  /**  Below 100 GHz  **/
	else {  /**  Frequency too high  **/
		console.error("The FCC does not have exposure limits above 100 GHz.  Please try again.");
		return;
	}  /**  Frequency too high  **/
}
/* inputs:
  @controlled: this is controlled or uncontrolled (bool)
  @watts: max watts at transmitter
  @tdc: transmission duty cycle (~20% for voice, ~40% for CW)
  @winave: average window x/6 for controlled, x/30 for controlled
  @tloss: total losses from transmitter to antenna (fraction, not in dB)
  @gain: antenna gain (fraction, not in dB)
  @dx: distance from center of antenna in cm
  @ground: calculate ground reflections (bool)
  returns:
  @pd: power density
  @mpe: maximum permissible exposure
  @dxm: minimum distance to compliance in cm
*/
function calc_exposure(controlled, watts, tdc, winave, tloss, gain, freq, dx, ground) {
	//console.log('calc_exposure('+controlled+', '+watts+', '+tdc+', '+winave+', '+tloss+', '+gain+', '+freq+', '+dx+', '+ground);
	var power_w = tdc * tloss * watts * winave * gain;
	var power_mw = power_w * 1000;
	var rfe, mpe, mdx;
	if ((power_mw > 0) && (dx > 0)) {
		if (ground) {
			// EPA model says 1.6 times field strength or 1.6*1.6 power density factor
			gf = 2.56;
		} else {
			gf = 1;
		}
		rfe = (gf * power_mw) / (4 *Math.PI * Math.pow(dx,2));
		mpe = calc_mpe(freq, controlled);
		mdx = Math.sqrt((gf * power_mw)/(mpe * 4 * Math.PI));
	}
	//console.log("{rfe:"+rfe+", mpe:"+mpe+", mdx:"+mdx+"}");
	return {avgp:power_w, rfe:rfe, mpe:mpe, mdx:mdx};
}
function delvar(name) {
	window.localStorage.removeItem('rfe.'+name);
}
function setvar(name, value) {
	window.localStorage['rfe.'+name] = JSON.stringify(value);
}
function getvar(name, default_value) {
	var v = window.localStorage['rfe.'+name];
	if (v == null)
		return default_value;
	return JSON.parse(v);
}
SCHEMA = 2;
function update_schema(ver) {
	switch (ver) {
		case 1:
			// renamed some of the modulation factors
			var remap = {
				'SSB voice low': 'SSB: no processing',
				'SSB voice high': 'SSB: medium processing',
				'AM 50%': 'AM: 50% modulation',
				'AM 100%': 'AM: 100% modulation',
				'AM 0%': 'AM: carrier',
			};
			transmitters = load_transmitters();
			var updated_transmitters = false;
			for (var t in transmitters) {
				for (var tb in transmitters[t].bands) {
					for (k in remap) {
						if (k == transmitters[t].bands[tb].mod) {
							//console.log('updating '+transmitters[t].name+':'+transmitters[t].bands[tb].band+' modulation from "'+transmitters[t].bands[tb].mod+'" to "'+remap[k]+'"');
							transmitters[t].bands[tb].mod = remap[k];
							updated_transmitters = true;
						}
					}
				}
			}
			if (updated_transmitters) {
				save_transmitters();
			}
			delete transmitters;
			return true;
		case 2:
			// added bands to the list of things we save so users
			// can have custom bands outside of standard ham bands
			// but really we don't have to do anything here because
			// by default there are no custom bands...
			return true;
		default:
			return true;
	}
}
function check_schema() {
	var schema = getvar('schema', 0);
	var success = true;
	if (schema < SCHEMA) {
		//console.log('updating schema');
		for (var i=schema+1; i<=SCHEMA; i++) {
			console.log('updating to schema version '+i);
			success &= update_schema(i);
		}
		if (!success) {
			alert('Sorry, some database updates failed to apply.\nYour data may be broken now.  The best thing would be to edit\nanything that looks broken to see if you can fix it.');
		}
		setvar('schema', SCHEMA);
	} else if (schema > SCHEMA) {
		alert('The database schemas do not match, you must be viewing an old\nversion of the calculator with new data,\nor tried to import data from a newer version.\nClear your browser cache and try again.');
	}
}

if (('localStorage' in window) && window['localStorage'] !== null) {
	check_schema();
	$("#tabs").tabs();
	load_all_data();
	page_init();
	refresh();
}

}); })(jQuery);

//-->
</script>
</head><body bgcolor="#ffffff" text="#000000">

<div id="tabs">
	<ul class="initial-noshow">
		<li><a href="#transmitters"><span>Transmitters</span></a></li>
		<li><a href="#antennas"><span>Antennas</span></a></li>
		<li><a href="#connections"><span>Connections</span></a></li>
		<li><a href="#results"><span>Results</span></a></li>
		<li><a href="#eximport"><span>Import/Export</span></a></li>
		<li><a href="#about"><span>About</span></a></li>
	</ul>
	<div id="transmitters" class="initial-noshow">
		<a class="link add-a primary-link" id="add-a-xmtr">Add a transmitter</a>
		<a class="link help" id="help-xmtr">Help!</a>
		<div class="help" id="help-text-xmtr">
			<a class="link help-hide" id="help-hide-xmtr">Hide help</a>
			<h2>Transmitters</h2>
			<p>
			The Transmitters tab is where you should start.  In this tab, you
			add a transmitter for each one you want to run calculations for.
			You get to pick the name, but the names must be unique, so if you
			have three of one radio, give them a suffix or something.
			</p><p>
			After clicking on "Add a transmitter", you will be prompted to "Add
			a band" for that transmitter.  Just like your real radio, each
			transmitter here can have its own bands.  It will continue to
			prompt you to add new bands until you hit "Cancel".  If you decide
			at some later time to add more bands, you can manually click on the
			"Add a band" link inside the transmitter box.  Deleting or editing
			the bands and/or transmitters can be done with those links as well.
			</p><p>
			As you add the bands, you specify information on how you will be
			using that band for this calculator.  For example, if you typically
			use 50W on the 80m band while using CW, you should enter that data
			there.  This way, you can model your real-life usage of the radio.
			In addition, you should enter your usage windows for controlled and
			uncontrolled exposure.  Remember that the controlled exposure
			window is six minutes long and the uncontrolled window is 30
			minutes.  These two fields here are not in minutes, but rather in
			percentage.  So fill in the percentages appropriately.
			</p><p>
			If you are using an amplifier with your radio, you can just assume
			that the radio is putting out the amplifier's output for the sake
			of simplification.
			</p><p>
			You only get to fill out each band once per transmitter, so use the
			highest power configuration you plan on using.  Note that the
			various modulation modes and exposure percentages will also reduce
			the total RFE in the calculations.
			</p><p>
			After adding all your transmitters and transmitter bands, go on to
			the Antennas tab.
			</p>
		</div>
		<div class="dynamic">
		</div>
	</div>
	<div id="antennas" class="initial-noshow">
		<a class="link add-a primary-link" id="add-a-antenna">Add an antenna</a>
		<a class="link help" id="help-antenna">Help!</a>
		<div class="help" id="help-text-antenna">
			<a class="link help-hide" id="help-hide-antenna">Hide help</a>
			<h2>Antennas</h2>
			<p>
			The Antennas tab is where you enter information about your
			antennas.  This includes the controlled and uncontrolled distances
			for which we are making calculations.  Also, it gives you a chance
			to enter the gain for each band that the antenna will be used with.
			</p><p>
			Click on "Add an antenna" to start with and enter the basic
			information.  The "Ground reflections" entry is whether or not to
			use the formula to incorporate ground reflections in the RFE
			totals.  I use it, but you should refer to Bulletin 65 for what you
			think you should do.  The controlled and uncontrolled distances are
			basically how close you and your household can get to the antenna
			and how close anyone else can get to it.
			</p><p>
			After saving the antenna, you will be prompted to add bands until
			you hit the "Cancel" button.  This allows you to set the gain for
			each band.  This gain is used in the formulas for calculating RFE.
			It should be listed as dBi, not dBd.  If your antenna specs are in
			dBd, take the dBd number and add 2.15 to it.
			</p><p>
			If you need to, you can always go back and add, delete or edit the
			bands that you have created.  When you have entered all your
			antennas, move on to the Connections tab.
			</p>
		</div>
		<div class="dynamic">
		</div>
	</div>
	<div id="connections" class="initial-noshow">
		<a class="link add-a primary-link" id="add-a-connection">Add a connection</a>
		<a class="link help" id="help-connection">Help!</a>
		<div class="help" id="help-text-connection">
			<a class="link help-hide" id="help-hide-connection">Hide help</a>
			<h2>Connections</h2>
			<p>
			The Connections tab is where you define the connections that are
			between your transmitters and your antennas.  Each
			transmitter/antenna pair can only have one connection, but each
			transmitter can connect to multiple antennas and each antenna can
			be connected to multiple transmitters, with each connection having
			different characteristics.
			</p><p>
			Things that are included in the connection properties are wire
			type, wire length, tuner losses, and any other losses (lightning
			suppressors, line splitters, etc.)  This allows you to have a wide
			range of flexibility in accurately modeling your connection setup.
			All losses are specified in dB, so be sure to enter them that way.
			If you need to add multiple losses to put in the other losses
			field, you just add the dB values together.
			</p><p>
			Currently, I only have specs on a few wire types available, but if
			you want this application to have more, feel free to send the specs
			to me and I will add them.  Just make sure that they cover a wide
			range so they can be used on lots of bands.
			</p><p>
			Add a connection for every physical connection you plan on
			modeling.  You will see a section for each connection in the
			Results tab.
			</p>
		</div>
		<div class="dynamic">
		</div>
	</div>
	<div id="results" class="initial-noshow">
		<a class="link help" id="help-results">Help!</a>
		<div class="help" id="help-text-results">
			<a class="link help-hide" id="help-hide-results">Hide help</a>
			<h2>Results</h2>
			<p>
			The Results tab is where all the results of the calculations are
			shown for each of the radio/connection/antenna groups that you have
			specified.
			</p><p>
			Listed in convenient tables, you see the data you entered in the
			first few columns and then starting with "Power at Antenna", you
			see the ERP for each band.  Then, using that number, the
			calculations show the RFE at both the controlled and uncontrolled
			distances, the minimum allowable distance for each band and then
			whether or not the band is within the limitations set by the FCC.
			</p><p>
			For each connection shown in the Results tab, and for each band
			within those connections, you should make sure that both the
			controlled and uncontrolled exposures are within the limits.  There
			is a box that will say "yes" or "no" for each entry.  If any of the
			boxes say "no", then you need to look into your setup to see what
			you can do to reduce the RF exposure for that band.  Some options
			are to: </p><ol>
			<li>Use a lower output power</li>
			<li>Use a smaller operating window (i.e. transmit for less time in
			each six or 30 minutes segments)</li>
			<li>Use a modulation that is less power (FM is 100% modulation
			whereas CW is only about 40%)</li>
			<li>Use a lower-gain antenna or a more lossy network (it would be a
			better idea to just turn down the power)</li>
			</ol>
		</div>
		<div class="dynamic">
		</div>
	</div>
	<div id="eximport" class="initial-noshow">
		<a class="link help" id="help-eximport">Help!</a>
		<div class="help" id="help-text-eximport">
			<a class="link help-hide" id="help-hide-eximport">Hide help</a>
			<h2>Import/Export</h2>
			<p>
			In the Import/Export tab, you can save your information for another
			day or copy it to send to a friend.  All the data is already stored
			in your browser (only locally&mdash;the application transmits no
			data back to the server&mdash;all the calculations and data are
			done on the client).
			</p><p>
			To export, hit the Export button and the data will all show up in a
			weird looking format that can be copied and saved in a text file.
			Then you can send it to a friend or use it later.
			</p><p>
			To import, paste exported data into the text area and hit the
			Import button.  This will try to slurp up all the data and make
			sense of it.  If something goes wrong, it should gracefully die,
			without destroying what is already on your system.
			</p><p>
			To clear all the data off your system, press the "Clear all data"
			button.  This will remove all saved settings from this application
			from your browser, allowing you to start over with a clean slate.
			</p><p>
			To view some sample data, you can click on the "Reset to sample
			data" button.  This will remove all previous settings and replace
			them with some canned settings.
			</p>
		</div>
		<div class="edit-items">
		<input id="eximport-import" type="button" name="import" value="Import"/>
		<input id="eximport-export" type="button" name="export" value="Export"/>
		<input id="eximport-reset" type="button" name="reset" value="Reset all data"/>
		<input id="eximport-sample" type="button" name="reset" value="Reset to sample data"/>
		</div>
		<textarea id="eximport-data" rows="20" cols=80"></textarea>
	</div>
	<div id="about">
		<div class="text hideme">
		<h2>Your Web Browser is Not Supported</h2>
		<p>Sorry for the inconvenience. The N7OH RFE Calculator requires just
		about anything except Internet Explorer.  Rumor has it that it works on
		IE 8 (and later versions), but you run that at your own risk;
		I am not able to test that browser.
		Try <a href="http://www.getfirefox.com/">
		FireFox</a>, <a href="http://www.opera.com/download/">Opera</a>,
		<a href="http://www.google.com/chrome">Chrome</a>, or maybe even Safari.
		Whatever you try, make sure it is a new browser that supports HTML 5.
		In addition, you <b>must have JavaScript enabled</b> for this page
		or it will not work at all.
		</p>
		<p>73,<br/>Vernon Mauery, N7OH</p>
		</div>
	<p>
	RF Exposure Calculator - Helping hams understand the mysteries of RF Exposure<br/>
	Copyright &copy; 2009-2014 <a href='http://vernon.mauery.com/'>Vernon Mauery</a> (N7OH)<br/>
	</p>
	<div class="text"><p>
	The idea originated from the <a
	href='http://hintlink.com/power_density.htm'>power density calculator
	written by W4/VP9KF</a>.
	I started writing my own javascript version only to find that it was
	really annoying to need to retype everything in each time I visited
	the page.  I wanted something that would store my data.  And I wanted
	to be able to share the application with others, but I didn't want to
	store <i>their</i> information.  I finally learned about local storage
	with HTML 5 and decided that I could use that for this application.
	</p><p>
	If you have questions, comments, suggestions, flames or anything else
	you would like to tell the author, please send an email: <span id="contact">[my call sign] at arrl dot net</span>
	</p>
	</div>
	<hr/>
	<tt><p>
	This program is free software: you can redistribute it and/or modify<br/>
	it under the terms of the GNU General Public License as published by<br/>
	the Free Software Foundation, either version 3 of the License, or<br/>
	(at your option) any later version.<br/>
	</p><p>
	This program is distributed in the hope that it will be useful,<br/>
	but WITHOUT ANY WARRANTY; without even the implied warranty of<br/>
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the<br/>
	GNU General Public License for more details.<br/>
	</p><p>
	You should have <a href="LICENSE">received a copy</a> of the GNU General Public License<br/>
	along with this program.  If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p></tt>
	</div>
</div>
<div id="editor-forms" class="initial-noshow">
<div id="xmtr-editor">
	<div id="xmtr-editor-msg" class="form-error"></div>
	<div class="edit-item">
		<label for="edit-xmtr-name">Name</label>
		<input type="textbox" id="edit-xmtr-name" name="name" value=""/>
	</div>
</div>
<div id="tband-editor">
	<div id="tband-editor-msg" class="form-error"></div>
	<div class="edit-item">
		<label for="edit-tband-band">Band</label>
		<select id="edit-tband-band"></select/>
	</div>
	<div class="edit-item">
		<label for="edit-tband-power">Power (W)</label>
		<input type="textbox" class="number" id="edit-tband-power" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-tband-mod">Modulation</label>
		<select id="edit-tband-mod"></select>
	</div>
	<div class="edit-item">
		<label for="edit-tband-ce">Controlled exposure (%)</label>
		<input type="textbox" class="number" id="edit-tband-ce" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-tband-ue">Uncontrolled exposure (%)</label>
		<input type="textbox" class="number" id="edit-tband-ue" value=""/>
	</div>
</div>
<div id="aband-editor">
	<div id="aband-editor-msg" class="form-error"></div>
	<div class="edit-item">
		<label for="edit-aband-band">Band</label>
		<select id="edit-aband-band"></select>
	</div>
	<div class="edit-item">
		<label for="edit-aband-gain">Gain (dBi)</label>
		<input type="textbox" class="number" id="edit-aband-gain" value=""/>
	</div>
</div>
<div id="antenna-editor">
	<div id="antenna-editor-msg" class="form-error"></div>
	<div class="edit-item">
		<label for="edit-antenna-name">Name</label>
		<input type="textbox" id="edit-antenna-name" name="name" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-antenna-cdx">Controlled exposure (ft)</label>
		<input type="textbox" class="number" id="edit-antenna-cdx" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-antenna-udx">Uncontrolled exposure (ft)</label>
		<input type="textbox" class="number" id="edit-antenna-udx" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-antenna-ground">Ground reflections</label>
		<select id="edit-antenna-ground">
			<option value="true">True</option>
			<option value="false">False</option>
		</select>
	</div>
</div>
<div id="conn-editor">
	<div id="conn-editor-msg" class="form-error"></div>
	<div class="edit-item">
		<label for="edit-conn-xmtr">Transmitter</label>
		<select id="edit-conn-xmtr"></select/>
	</div>
	<div class="edit-item">
		<label for="edit-conn-ant">Antenna</label>
		<select id="edit-conn-ant"></select/>
	</div>
	<div class="edit-item">
		<label for="edit-conn-tloss">Tuner losses (dB)</label>
		<input type="textbox" class="number" id="edit-conn-tloss" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-conn-wire">Wire type</label>
		<select id="edit-conn-wire"></select>
	</div>
	<div class="edit-item">
		<label for="edit-conn-wlen">Wire length (ft)</label>
		<input type="textbox" class="number" id="edit-conn-wlen" value=""/>
	</div>
	<div class="edit-item">
		<label for="edit-conn-other">Other losses (dB)</label>
		<input type="textbox" class="number" id="edit-conn-other" value=""/>
	</div>
</div>
</div>
</body>
</html>

